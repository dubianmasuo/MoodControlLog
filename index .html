<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mood Control Log</title>
    <style>
        /* æ ·å¼ä¼˜åŒ–ï¼šæ›´æŸ”å’Œçš„é…è‰²ã€åœ†è§’ã€é˜´å½± (ä¿æŒä¸å˜) */
        body { font-family: 'Arial', 'Microsoft YaHei', sans-serif; line-height: 1.6; max-width: 880px; margin: 25px auto; padding: 0 18px; background-color: #f0f2f5; }
        
        /* 1. æ ‡é¢˜ç¾åŒ– */
        h2 { 
            border-bottom: 2px dashed #b3cde0; /* æ”¹ä¸ºæŸ”å’Œçš„è™šçº¿ */
            padding-bottom: 8px; 
            color: #1e3a8a; 
            text-align: center; 
            margin-bottom: 22px; 
            font-family: 'Georgia', 'serif', 'Microsoft YaHei'; /* æ ‡é¢˜å°è¯•ä½¿ç”¨è¡¬çº¿ä½“å¢å¼ºè´¨æ„Ÿ */
            letter-spacing: 1px; /* å¢åŠ å­—æ¯é—´è· */
        }
        h3 { 
            color: #1f4b99; 
            margin-top: 22px; 
            border-left: 4px solid #a8c4fa; /* æŸ”å’Œçš„æµ…è“å·¦ä¾§çº¿ */
            padding-left: 10px; 
            font-weight: 600; /* ç•¥å¾®é™ä½ç²—ç»† */
        }
        
        /* 2. åŒºå—ä¼˜åŒ– */
        .section { 
            margin-bottom: 26px; 
            padding: 20px; /* å¢åŠ å†…è¾¹è· */
            border: 1px solid #e0e7ff; /* è¾¹æ¡†æ›´æ·¡ */
            background-color: #ffffff; 
            border-radius: 12px; /* ç•¥å¾®å¢å¤§åœ†è§’ */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08); /* å¢åŠ é˜´å½±æŸ”å’Œåº¦ */
        }
        
        table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        th, td { border: 1px solid #e5e7eb; padding: 10px; text-align: left; vertical-align: top; }
        th { background-color: #e8f0ff; color: #1e3a8a; font-weight: 700; }
        
        input[type="text"], input[type="date"], input[type="number"], select, input[type="time"] { width: 100%; max-width: 460px; padding: 7px 9px; border: 1px solid #c5ccd6; border-radius: 6px; box-sizing: border-box; transition: border-color 0.3s, box-shadow 0.2s; background: #fff; font-family: inherit; white-space: normal; word-break: break-word; line-height: 1.3; min-height: 28px; }
        
        /* 3. æŸ”å’Œçš„è¾“å…¥æ¡†èšç„¦æ•ˆæœ */
        input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, input[type="time"]:focus, textarea:focus { 
            border-color: #7b9fe8; /* æŸ”å’Œçš„èšç„¦è¾¹æ¡† */
            outline: none; 
            box-shadow: 0 0 0 3px rgba(123, 159, 232, 0.2); /* æŸ”å’Œçš„å…‰æ™• */
        }
        
        input[type="date"], input[type="time"] { max-width: 220px; padding: 8px; }
        textarea { width: 100%; min-height: 52px; padding: 8px 9px; border: 1px solid #c5ccd6; border-radius: 6px; box-sizing: border-box; resize: vertical; font-family: inherit; white-space: pre-wrap; word-break: break-word; line-height: 1.35; }
        
        /* ç¦ç”¨çŠ¶æ€çš„æ ·å¼ (ä¿æŒä¸å˜) */
        input[disabled], textarea[disabled], input[type="range"][disabled] {
            cursor: not-allowed;
            background-color: #f7f7f7 !important;
            border-color: #e5e7eb !important;
            color: #9ca3af;
        }
        input[type="range"][disabled]::-webkit-slider-thumb {
            background: #aeb5c2 !important;
            box-shadow: none !important;
        }

        ::placeholder { font-family: inherit; color: #9ca3af; opacity: 1; white-space: normal; word-break: break-word; line-height: 1.3; }
        .mobile-hint { display: none; color: #6b7280; font-size: 0.9em; margin-top: 4px; }
        
        /* 4. ç¬”è®°å’Œæç¤ºæ–‡å­—ç¾åŒ– */
        .note { 
            font-size: 0.9em; 
            color: #7889a7; /* ç•¥å¾®åŠ æ·±çš„æŸ”å’Œç°è“è‰² */
            margin-top: 5px; 
            display: block; 
            /* font-style: italic; <-- å·²ç§»é™¤ */
        }
        
        /* 6. å¿ƒæ³•æ¨¡å—ä¼˜åŒ– */
        .mindset { 
            background-color: #f5f8ff; /* æ›´æ·¡çš„èƒŒæ™¯ */
            border-left: 5px solid #a8c4fa; /* æŸ”å’Œçš„å·¦ä¾§çº¿ */
            padding: 18px; 
            margin-top: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); 
        }
        
        /* è®°å½•å¿ƒæ³•æ–‡å­—ç¼©å° */
        .mindset p { margin: 5px 0; color: #1e3a8a; font-size: 0.9em; } 
        
        .mindset strong { font-size: 1.1em; }
        .actions { display: flex; flex-wrap: wrap; gap: 10px; margin: 14px 0 6px; }
        .date-row { 
            display: flex; 
            flex-wrap: wrap; 
            align-items: center; 
            gap: 10px; 
            /* ä¿®æ­£å¯¹é½çš„å®¹å™¨ */
            margin-bottom: 4px; /* è°ƒæ•´é—´è· */
        }
        .date-status { font-size: 0.9em; color: #374151; }
        .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; background-color: #2563eb; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95em; box-shadow: 0 3px 8px rgba(37, 99, 235, 0.25); transition: transform 0.1s ease, background-color 0.2s; }
        .btn:hover { background-color: #1d4ed8; }
        .btn:active { transform: translateY(1px); }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; box-shadow: none; transform: none; }
        .btn.secondary { background-color: #6b7280; box-shadow: 0 3px 8px rgba(107, 114, 128, 0.25); }
        .btn.secondary:hover { background-color: #4b5563; }
        .btn.secondary:disabled { background-color: #9ca3af; }
        
        /* æ–°å¢æ ·å¼ï¼šç¡®ä¿æœ€è¿‘ä¿å­˜æ—¶é—´å•ç‹¬å ä¸€è¡Œ */
        .last-save-display { 
            font-size: 0.9em; 
            color: #4b5563; 
            margin: 4px 0 8px 0; /* åœ¨è¯´æ˜æ–‡å­—ä¸Šæ–¹ç•™å‡ºé—´è· */
        }
        .last-save-time { /* æ›´å…·ä½“çš„æ ·å¼åº”ç”¨äºæ—¶é—´æ–‡æœ¬ */
            font-weight: 600; 
            color: #1e3a8a;
        }

        .inline-hint { 
            font-size: 0.9em; 
            color: #4b5563; 
            margin-top: 0; /* ç¡®ä¿ç´§æ¥åœ¨ä¸Šæ–¹ä¿å­˜æ—¶é—´è¡Œä¹‹å */
        }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; margin-top: 10px; }
        .metric { border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; background: #f9fafb; box-shadow: 0 2px 4px rgba(0,0,0,0.04); }
        .metric-label { display: flex; align-items: center; gap: 8px; font-weight: 700; color: #1e3a8a; }
        .metric-body { font-size: 0.95em; color: #374151; margin: 6px 0 10px; }
        .metric-score { max-width: 100%; }
        .inline-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin: 4px 0; }
        .inline-label { white-space: nowrap; font-weight: 600; color: #1e3a8a; }
        .inline-row textarea, .inline-row input { flex: 1 1 0; min-width: 0; }
        .btn.ghost { background: #eef2ff; color: #1e3a8a; box-shadow: none; }
        .btn.ghost:hover { background: #dbeafe; }
        .btn.ghost:disabled { background-color: #e5e7eb; color: #9ca3af; }
        .toast { position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%); background: rgba(31,41,55,0.9); color: #fff; padding: 10px 14px; border-radius: 8px; box-shadow: 0 8px 20px rgba(0,0,0,0.18); font-size: 0.95em; opacity: 0; pointer-events: none; transition: opacity 0.2s ease; z-index: 9999; }
        .toast.show { opacity: 1; }
        h4 { margin: 10px 0 6px; }
        .note { margin-top: 2px; }
        /* è¯„åˆ†æ»‘å—æ ·å¼ - ä»…ä¿ç•™ 1 å’Œ 10 æ ‡ç­¾ (ä¿æŒä¸å˜) */
        .rating-labels { display: flex; justify-content: space-between; font-size: 0.9em; color: #6b7280; padding: 0 2px; margin-top: 2px; font-weight: bold; }
        .rating-value { font-weight: 700; color: #1e3a8a; text-align: center; margin-top: 4px; font-size: 1.1em; }
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #e0e7ff; border-radius: 5px; transition: opacity .2s; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #4f8ef5; cursor: pointer; border: 2px solid #ffffff; box-shadow: 0 0 4px rgba(0, 0, 0, 0.15); }
        input[type="range"]::-moz-range-thumb { width: 18px; height: 18px; border-radius: 50%; background: #4f8ef5; cursor: pointer; border: 2px solid #ffffff; box-shadow: 0 0 4px rgba(0, 0, 0, 0.15); }
        input[type="range"][disabled]::-webkit-slider-thumb { background: #aeb5c2 !important; }

        /* å›¾è¡¨æ ·å¼ (ä¿æŒä¸å˜) */
        #chart-container {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 140px; 
            gap: 10px;
            padding: 10px 0;
            border-bottom: 2px solid #e5e7eb;
            position: relative; 
            padding-left: 20px; 
            box-sizing: content-box;
        }
        .chart-ref-line {
            position: absolute;
            left: 20px; 
            width: calc(100% - 20px);
            border-top: 1px dotted #d1d5db;
        }
        .ref-label {
             position: absolute;
             left: 0px;
             font-size: 0.75em;
             color: #6b7280;
             line-height: 1;
             transform: translateY(-50%); 
             font-weight: 500;
        }
        .day-chart {
            flex: 1 1 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            min-width: 30px;
        }
        .bar-group {
            display: flex;
            align-items: flex-end;
            height: 100px; 
            width: 100%;
            justify-content: center;
            gap: 2px;
            position: relative; 
        }
        .chart-bar {
            width: 45%;
            transition: height 0.3s ease;
            border-radius: 3px 3px 0 0;
            opacity: 0.9;
            min-height: 1px; 
        }
        .chart-bar-mood { background-color: #4f8ef5; } 
        .chart-bar-energy { background-color: #10b981; } 
        .chart-label {
            font-size: 0.8em;
            color: #6b7280;
            margin-top: 5px;
            text-align: center;
        }
        .score-label {
            position: absolute;
            text-align: center;
            font-size: 0.75em; 
            font-weight: bold;
            transition: all 0.3s ease;
            transform: translateY(-100%); 
            line-height: 1;
        }
        .mood-label { 
            left: 5%; 
            width: 45%; 
            color: #1e3a8a; 
        }
        .energy-label { 
            left: 50%; 
            width: 45%; 
            color: #065f46; 
        }
        
        /* æ–°å¢å›¾ä¾‹æ ·å¼ */
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            font-size: 0.9em;
            color: #4b5563;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-color-box {
            width: 16px;
            height: 10px;
            border-radius: 3px;
        }
        .legend-mood { background-color: #4f8ef5; } /* æƒ…ç»ªè“è‰² */
        .legend-energy { background-color: #10b981; } /* èƒ½é‡ç»¿è‰² */

        /* 5. æ—¥å†ç¾åŒ– */
        #calendar-container {
            padding: 15px; /* å¢åŠ å†…è¾¹è· */
            background-color: #fcfdff; /* æ›´äº®çš„èƒŒæ™¯ */
            border-radius: 10px;
            margin-top: 15px;
            box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.05); /* æŸ”å’Œçš„å†…åµŒé˜´å½± */
        }

        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            gap: 5px;
        }

        .day-name {
            font-weight: 700;
            color: #4b5563;
            padding: 8px 0;
            font-size: 0.9em;
        }

        .calendar-day {
            padding: 8px 0;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s;
            font-size: 0.95em;
            min-height: 20px; /* ç¡®ä¿æœ‰ç‚¹å‡»åŒºåŸŸ */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            color: #374151; /* é»˜è®¤é¢œè‰² */
        }

        .calendar-day:hover:not(.empty-day) {
            background-color: #e0e7ff;
        }

        .calendar-day.today {
            border: 2px solid #2563eb;
            background-color: #dbeafe;
            font-weight: 700;
        }

        /* --- ä¿®æ­£ï¼šé€‰ä¸­æ—¥æœŸæ ·å¼ --- */
        .calendar-day.selected-day {
            background-color: #ffe0b2; /* æŸ”å’Œçš„æ©™è‰²æˆ–æš–è‰² */
            border: 2px solid #ff9800;
            color: #333;
            font-weight: 700;
            transform: scale(1.05); /* ç¨å¾®æ”¾å¤§ï¼Œçªå‡ºé€‰ä¸­çŠ¶æ€ */
        }
        /* é€‰ä¸­ä¸”ä¸ºä»Šå¤© */
        .calendar-day.today.selected-day {
            border: 2px solid #ff9800; /* é€‰ä¸­çŠ¶æ€æ›´çªå‡º */
            background-color: #fff3e0; /* é€‰ä¸­ä¸”ä¸ºä»Šå¤©ï¼Œç”¨æµ…æ©™è‰² */
        }
        /* --- ç»“æŸï¼šé€‰ä¸­æ—¥æœŸæ ·å¼ --- */

        .calendar-day.recorded {
            background-color: #90ee90; /* æŸ”å’Œçš„æ·¡ç»¿è‰² */
            color: #1e3a8a; /* æ·±è“è‰²æ–‡å­— */
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(144, 238, 144, 0.5);
            border: 1px solid #7cb97c; /* æ·»åŠ æ·¡ç»¿è‰²è¾¹æ¡† */
        }

        .calendar-day.recorded:hover {
            background-color: #7ccd7c;
        }

        .calendar-day.empty-day {
            color: #aeb5c2;
            cursor: default;
            background-color: transparent;
        }

        /* å°åœ†ç‚¹æ ‡è®° - å¯é€‰ */
        .recorded-mark {
            position: absolute;
            bottom: 2px;
            font-size: 0.7em;
            color: #1e3a8a; /* é…åˆæ·¡ç»¿è‰²èƒŒæ™¯ä¿®æ”¹é¢œè‰² */
            line-height: 1;
        }

        @media (max-width: 640px) {
            /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
            body { 
                font-size: 15px; /* å°†åŸºç¡€å­—ä½“ç•¥å¾®ç¼©å° */
                padding: 0 12px; /* å‡å°ä¸¤ä¾§è¾¹è· */
            }
            h2 { 
                font-size: 1.25em; /* è¿›ä¸€æ­¥ç¼©å°æ ‡é¢˜å­—ä½“ */
                white-space: nowrap; /* å¼ºåˆ¶ä¸æ¢è¡Œ */
                overflow: hidden; /* éšè—è¶…å‡ºéƒ¨åˆ† */
                text-overflow: ellipsis; /* é˜²æ­¢å®½åº¦ä¸è¶³æ—¶å‡ºç°æ°´å¹³æ»šåŠ¨æ¡ */
                margin-bottom: 16px; 
            }
            h3 { 
                font-size: 1.1em; /* äºŒçº§æ ‡é¢˜ç•¥å¾®ç¼©å° */
            }
            .metric-body {
                font-size: 0.9em; /* è¯„åˆ†è¯´æ˜æ–‡å­—ç¼©å° */
            }
            .btn, input, textarea {
                font-size: 0.9em; /* æŒ‰é’®å’Œè¾“å…¥æ¡†çš„å­—ä½“å¤§å°ç¼©å° */
            }
            .metrics { grid-template-columns: 1fr; }
            .mobile-hint { display: block; }
            #chart-container { padding-left: 15px; height: 120px; }
            .chart-ref-line { left: 15px; width: calc(100% - 15px); }
            .ref-label { left: 0px; }
            .score-label { font-size: 0.7em; }

            /* ç§»åŠ¨ç«¯æ—¥å†ä¼˜åŒ– */
            #calendar-grid {
                gap: 3px;
            }
            .calendar-day {
                font-size: 0.9em;
                padding: 6px 0;
            }
            .day-name {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>

    <h2>ğŸ’« æ¯æ—¥çŠ¶æ€è½»è®°å½•ï¼šé‡å»ºè‡ªæˆ‘è¿æ¥ ğŸ’–</h2>

    <div class="section mindset">
        <h3>ğŸ”‘ åšæŒçš„è¯€çªï¼šè¶Šç®€å•è¶Šå¥½</h3>
        <p>1. å›ºå®šæ—¶é—´ï¼šå»ºè®®åœ¨ç¡å‰æˆ–æ—©æ™¨ï¼Œé€‰æ‹©ä¸€ä¸ªå›ºå®šæ—¶é—´æ¥åšè®°å½•ï¼Œå½¢æˆä¹ æƒ¯</p>
        <p>2. æç®€åŸåˆ™ï¼šå¦‚æœä»Šå¤©ä½ æ„Ÿè§‰ç‰¹åˆ«ç´¯ï¼Œåªè®°å½• æƒ…ç»ªå’Œèƒ½é‡è¯„åˆ† æˆ– æœ€å¼€å¿ƒçš„äº‹ å³å¯ã€‚ä»»ä½•ä¸€ç‚¹è®°å½•éƒ½æ¯”å®Œå…¨æ”¾å¼ƒè¦å¥½</p>
        <p>3. ä¸å¸¦è¯„åˆ¤ï¼šè®°å½•æ—¶ä¸è¦è¯„åˆ¤è‡ªå·±â€œä»Šå¤©åˆæ²¡å®Œæˆä»»åŠ¡â€ã€â€œä»Šå¤©çš„æ¶ˆè´¹å¤ªé«˜äº†â€ã€‚è®°å½•çš„ç›®çš„æ˜¯å®¢è§‚äº†è§£çŠ¶æ€ï¼Œè€Œä¸æ˜¯æŒ‡è´£è‡ªå·±</p>
    </div>

    <div class="section">
        <h3>ğŸ“… åŸºæœ¬ä¿¡æ¯</h3>
        <div class="date-row">
            <strong>è®°å½•æ—¥æœŸï¼š</strong>
            <input id="date" name="date" type="date" aria-label="è®°å½•æ—¥æœŸ">
            <button class="btn secondary" id="prev-day" type="button">â† å‰ä¸€å¤©</button>
            <button class="btn secondary" id="next-day" type="button">åä¸€å¤© â†’</button>
            <button class="btn ghost" id="goto-today" type="button">å›åˆ°ä»Šå¤©</button>
            <button class="btn ghost" id="clear-day" type="button">æ¸…ç©ºå½“å‰</button>
            <span class="date-status" id="date-status"></span>
        </div>
        <p class="last-save-display"><span id="last-save" class="last-save-time"></span></p>
        <div class="inline-hint">é»˜è®¤å¡«å…¥ä»Šå¤©ã€‚åˆ‡æ¢æ—¥æœŸå³å¯æŸ¥çœ‹/å¡«å†™å†å²è®°å½•ã€‚ç³»ç»Ÿç¦æ­¢å¡«å†™æœªæ¥æ—¥æœŸï¼Œå‡è½»æ‚¨çš„â€œé¢„è®¾â€å‹åŠ›ã€‚</div>
    </div>

    <div class="section">
        <h3>VI. è®°å½•æ—¥å†æ¦‚è§ˆ (å¯ç‚¹å‡»)</h3>
        <div id="calendar-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <button class="btn ghost" id="prev-month-btn" type="button">â† ä¸Šä¸ªæœˆ</button>
                <h4 id="current-month-year" style="margin: 0; color: #1e3a8a;"></h4>
                <button class="btn ghost" id="next-month-btn" type="button">ä¸‹ä¸ªæœˆ â†’</button>
            </div>
            <div id="calendar-grid">
                <div class="day-name">æ—¥</div>
                <div class="day-name">ä¸€</div>
                <div class="day-name">äºŒ</div>
                <div class="day-name">ä¸‰</div>
                <div class="day-name">å››</div>
                <div class="day-name">äº”</div>
                <div class="day-name">å…­</div>
                </div>
        </div>
        <div class="note">âœ… æ ‡è®°çš„æ—¥æœŸè¡¨ç¤ºæ‚¨å·²å¡«å†™è®°å½•ã€‚ç‚¹å‡»æ—¥æœŸå¯å¿«é€Ÿè·³è½¬ã€‚</div>
    </div>
    <div class="section">
        <h3>I. å½“ä¸‹æ„Ÿå—çš„æ•æ‰</h3>
        <div class="metrics">
            <div class="metric">
                <div class="metric-label">æƒ…ç»ªè¯„åˆ† (1-10)</div>
                <div class="metric-body">æ­¤åˆ»çš„æ€»ä½“æ„Ÿå—æ˜¯ä»€ä¹ˆï¼Ÿ1=éå¸¸ä½è½ï¼Œ5=å¹³é™/ä¸­æ€§ï¼Œ10=éå¸¸å¿«ä¹</div>
                <div class="rating-value" id="mood-value">5</div>
                <input type="range" min="1" max="10" step="1" value="5" class="metric-score" name="mood" id="mood-range" aria-label="æƒ…ç»ªè¯„åˆ†">
                <div class="rating-labels">
                    <span>1</span>
                    <span>10</span>
                </div>
            </div>
            <div class="metric">
                <div class="metric-label">èƒ½é‡è¯„åˆ† (1-10)</div>
                <div class="metric-body">æ­¤åˆ»èº«ä½“æ„Ÿå—åˆ°çš„ç²¾åŠ›å¦‚ä½•ï¼Ÿ1=ç–²æƒ«æ— åŠ›ï¼Œ5=æ­£å¸¸/å¹³ç¨³ï¼Œ10=å……æ»¡æ´»åŠ›</div>
                <div class="rating-value" id="energy-value">5</div>
                <input type="range" min="1" max="10" step="1" value="5" class="metric-score" name="energy" id="energy-range" aria-label="èƒ½é‡è¯„åˆ†">
                <div class="rating-labels">
                    <span>1</span>
                    <span>10</span>
                </div>
            </div>
            <div class="metric">
                <div class="metric-label">ç¡çœ è®°å½•</div>
                <div class="metric-body">å¿…è®°é¡¹ï¼Œå³ä½¿æ˜¯å¤±çœ åˆ°å‡Œæ™¨4ç‚¹ä¹Ÿè¦å¦‚å®è®°å½•</div>
                <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
                    <span>å…¥ç¡æ—¶é—´ï¼š</span>
                    <input type="time" name="sleepStart" aria-label="å…¥ç¡æ—¶é—´">
                    <span>é†’æ¥æ—¶é—´ï¼š</span>
                    <input type="time" name="sleepEnd" aria-label="é†’æ¥æ—¶é—´">
                </div>
            </div>
        </div>
    </div>

    <div class="section">
        <h3>II. å€¼å¾—è¢«çœ‹è§çš„ç¾å¥½ä¸å°èƒœåˆ©</h3>
        
        <h4>ä»Šæ—¥æœ€å¼€å¿ƒçš„ä¸‰ä»¶äº‹</h4>
        <div class="note">ä¸ä¸€å®šè¦æ˜¯â€œå¤§äº‹â€ï¼Œè¶Šå…·ä½“è¶Šå¥½ã€‚ç§¯æå¿ƒç†å­¦ç»ƒä¹ ï¼Œè®­ç»ƒå¤§è„‘å»å¯»æ‰¾ç¾å¥½</div>
        <div class="inline-row"><span class="inline-label">1.</span><textarea name="happy1" rows="2" placeholder="ä¾‹å¦‚ï¼šé˜³å…‰æ´’åœ¨èº«ä¸Šå¾ˆèˆ’æœ" aria-label="æœ€å¼€å¿ƒçš„äº‹1"></textarea></div>
        <div class="inline-row"><span class="inline-label">2.</span><textarea name="happy2" rows="2" placeholder="ä¾‹å¦‚ï¼šå–åˆ°ä¸€æ¯å¥½å’–å•¡" aria-label="æœ€å¼€å¿ƒçš„äº‹2"></textarea></div>
        <div class="inline-row"><span class="inline-label">3.</span><textarea name="happy3" rows="2" placeholder="ä¾‹å¦‚ï¼šçœ‹åˆ°ä¸€ä¸ªæœ‰è¶£çš„è¡¨æƒ…åŒ…" aria-label="æœ€å¼€å¿ƒçš„äº‹3"></textarea></div>

        <h4>ä»Šæ—¥çš„æŒæ§æ„Ÿ</h4>
        <div class="note">è®°å½•ä¸€ä»¶æ‚¨ä¸»åŠ¨å®Œæˆçš„äº‹æƒ…ï¼Œå¢å¼ºå¯¹è‡ªæˆ‘è¡ŒåŠ¨çš„è‚¯å®š</div>
        <textarea name="action" rows="2" placeholder="ä¾‹å¦‚ï¼šæˆ‘æŒ‰æ—¶åƒäº†åˆé¥­ã€æˆ‘åšæŒè¿åŠ¨äº†10åˆ†é’Ÿã€æˆ‘ä¸ºé¢è¯•å‡†å¤‡äº†1ä¸ªå°æ—¶ã€æˆ‘æŠŠæ˜¨å¤©çš„æ—§é‚®ä»¶æ¸…ç†äº†" aria-label="ä»Šæ—¥çš„æŒæ§æ„Ÿ"></textarea>

        <h4>ä»Šæ—¥çš„è‡ªçˆ±è¡ŒåŠ¨</h4>
        <div class="note">è®°å½•ä¸€ä¸ªæ‚¨ä¸ºè‡ªå·±èº«ä½“æˆ–å¿ƒç†å¥åº·åšå‡ºçš„è¡ŒåŠ¨ï¼Œå…³æ³¨è‡ªæˆ‘éœ€æ±‚ï¼Œæ‰“ç ´æ‹–å»¶å¯¼è‡´çš„è‡ªæˆ‘æƒ©ç½š</div>
        <textarea name="selflove" rows="2" placeholder="ä¾‹å¦‚ï¼šæˆ‘æ²¡æœ‰ç†¬å¤œï¼Œåœ¨11ç‚¹å‰èººä¸‹äº†ã€æˆ‘ç»™çš®è‚¤æ¶‚äº†ä¹³æ¶²ã€æˆ‘å¬äº†30åˆ†é’Ÿçš„æ”¾æ¾éŸ³ä¹" aria-label="ä»Šæ—¥çš„è‡ªçˆ±è¡ŒåŠ¨"></textarea>

    </div>

    <div class="section">
        <h3>III. ä»…ä»…æ˜¯è§‚å¯Ÿä¸äº†è§£</h3>
        
        <h4>æƒ…ç»ªè§¦å‘ç‚¹</h4>
        <div class="note">å¦‚æœä»Šå¤©æƒ…ç»ªåˆ†ä½äº 5 åˆ†ï¼Œè®°å½•å‘ç”Ÿäº†ä¸€ä»¶ä»€ä¹ˆäº‹ï¼Œæˆ–è„‘æµ·é‡Œçªç„¶å†’å‡ºäº†ä»€ä¹ˆæƒ³æ³•ï¼Œå¯¼è‡´æƒ…ç»ªä¸‹æ»‘ï¼Œæ‰¾å‡ºå¼•èµ·ä½è½æˆ–ç„¦è™‘çš„å…·ä½“äº‹ä»¶</div>
        <textarea name="trigger" placeholder="ä¾‹å¦‚ï¼šé¢è¯•å®˜çš„ä¸€ä¸ªé—®é¢˜è®©æˆ‘è§‰å¾—è‡ªå·±èƒ½åŠ›å¾ˆå·®ï¼Œçªç„¶å¼€å§‹å¦å®šè‡ªå·±ã€‚" aria-label="æƒ…ç»ªå‹åŠ›è§¦å‘ç‚¹"></textarea>

        <h4>è‡ªæ•‘è¡Œä¸º</h4>
        <div class="note">æ‚¨åšäº†ä»€ä¹ˆæ¥é˜»æ­¢æƒ…ç»ªè¿›ä¸€æ­¥æ¶åŒ–ï¼Ÿè¯·è®°å½•è‡ªå·±å¦‚ä½•ä»ä½è½ä¸­è‡ªæ•‘</div>
        <textarea name="rescue" rows="2" placeholder="ä¾‹å¦‚ï¼šæˆ‘å‘æœ‹å‹å€¾è¯‰äº†ã€æˆ‘åœæ­¢äº†æ€è€ƒï¼Œå»çœ‹äº†ä¸€éƒ¨ç”µå½±ã€æˆ‘å‡ºå»æ•£æ­¥äº†10åˆ†é’Ÿã€‚" aria-label="è‡ªæ•‘è¡Œä¸º"></textarea>
        
        
        <h4>ä»Šæ—¥æ¶ˆè´¹é€Ÿè§ˆ</h4>
        <p><strong>æ¶ˆè´¹æ€»é¢ï¼š</strong> Â¥ <input name="spendTotal" type="number" step="0.01" min="0" placeholder="ä¾‹å¦‚ï¼š128.5" aria-label="ä»Šæ—¥æ¶ˆè´¹æ€»é¢"></p>
        
        <h4>æƒ…ç»ªæ€§æ¶ˆè´¹</h4>
        <div class="note">è®°å½•æ˜¯å¦å› ç„¦è™‘/æ— èŠ/ä½è½è€Œä¹°äº†ä¸œè¥¿ï¼Œè§‰å¯Ÿè‡ªå·±æ˜¯å¦ç”¨æ¶ˆè´¹æ¥åº”å¯¹æƒ…ç»ª</div>
        <textarea name="spendEmo" rows="2" placeholder="ä¹°çš„æ˜¯ä»€ä¹ˆï¼Œä»¥åŠè´­ä¹°æ—¶çš„æƒ…ç»ª" aria-label="æƒ…ç»ªæ€§æ¶ˆè´¹"></textarea>

        <h4>æŠ•èµ„æ€§æ¶ˆè´¹</h4>
        <div class="note">è®°å½•ä¸€ç¬”æ‚¨è§‰å¾—â€œå¾ˆå€¼â€æˆ–â€œå¯¹æœªæ¥æœ‰å¸®åŠ©â€çš„æ¶ˆè´¹ï¼ŒåŒºåˆ†æŠ•èµ„æ¶ˆè´¹ä¸æƒ…ç»ªæ¶ˆè´¹</div>
        <textarea name="spendValue" rows="2" placeholder="ä¾‹å¦‚ï¼šè´­ä¹°äº†é¢è¯•æ­£è£…ã€è´­ä¹°äº†ä¸€æœ¬å¥½ä¹¦ã€ä»˜äº†å¥èº«å¡è´¹ç”¨" aria-label="æŠ•èµ„æ€§æ¶ˆè´¹"></textarea>
        </div>

    <div class="section">
        <h3>IV. ç»™æ˜å¤©çš„è‡ªå·±</h3>
        <h4>æ˜å¤©åªéœ€å®Œæˆçš„ 3 ä»¶å°äº‹</h4>
        <div class="note">åªåˆ—å‡ºä¸‰ä»¶å¿…é¡»å®Œæˆä¸”å…·ä½“å¯æ‰§è¡Œçš„å°ä»»åŠ¡ï¼Œå°†æ˜å¤©çš„å‹åŠ›åˆ†è§£ï¼Œé¿å…è¿‡åº¦æ‹–å»¶ã€‚</div>
        <div class="inline-row"><span class="inline-label">1.</span><textarea name="todo1" rows="2" maxlength="120" placeholder="ä¾‹å¦‚ï¼šå‘é€ç®€å†åˆ°å…¬å¸A" aria-label="æ˜æ—¥ä»»åŠ¡1"></textarea></div>
        <div class="inline-row"><span class="inline-label">2.</span><textarea name="todo2" rows="2" maxlength="120" placeholder="ä¾‹å¦‚ï¼šç»™å¦ˆå¦ˆæ‰“ç”µè¯" aria-label="æ˜æ—¥ä»»åŠ¡2"></textarea></div>
        <div class="inline-row"><span class="inline-label">3.</span><textarea name="todo3" rows="2" maxlength="120" placeholder="ä¾‹å¦‚ï¼šæ´—å¹²å‡€æ˜¨å¤©å †ç§¯çš„è¡£æœ" aria-label="æ˜æ—¥ä»»åŠ¡3"></textarea></div>
        <div class="inline-hint">ä¸ºäº†è®©è¡ŒåŠ¨æ›´å®¹æ˜“è¢«å®Œæˆï¼Œå»ºè®®ä½¿ç”¨â€œåŠ¨è¯ + å¯¹è±¡ + æ—¶é—´/æ•°é‡â€çš„æè¿°æ–¹å¼ã€‚</div>
    </div>

    <div class="section">
        <h3>V. æœ€è¿‘ 7 å¤©å¿ƒæƒ…</h3>
        <div class="note">æœ€è¿‘7ä¸ªæœ‰è®°å½•æ—¥æœŸçš„æƒ…ç»ªå’Œèƒ½é‡è¶‹åŠ¿</div>
        <div id="chart-container">
            </div>
        <div class="chart-legend">
            <div class="legend-item">
                <span class="legend-color-box legend-mood"></span>
                <span>æƒ…ç»ªè¯„åˆ† (è“è‰²)</span>
            </div>
            <div class="legend-item">
                <span class="legend-color-box legend-energy"></span>
                <span>èƒ½é‡è¯„åˆ† (ç»¿è‰²)</span>
            </div>
        </div>
    </div>

    <div class="actions">
        <button class="btn" id="export-md" type="button">ğŸ“„ å¯¼å‡º Markdown</button>
        <button class="btn secondary" id="export-txt" type="button">ğŸ§¾ å¯¼å‡º TXT</button>
        <button class="btn secondary" id="print-page" type="button">ğŸ–¨ï¸ æ‰“å°/å¦å­˜ä¸ºPDF</button>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <script>
        // --- æ ¸å¿ƒå˜é‡ä¸åˆå§‹åŒ– ---
        // é‡æ–°å®šä¹‰ fields ä»¥ç¡®ä¿åŒ…å«æ–°çš„ 'rescue' å­—æ®µ
        const fields = Array.from(document.querySelectorAll('input, textarea, select')).filter(el => el.name && el.name !== 'date');
        const storageKey = 'daily-record-v2';
        const dateInput = document.getElementById('date');
        const dateStatus = document.getElementById('date-status');
        const nextDayBtn = document.getElementById('next-day'); 
        const clearDayBtn = document.getElementById('clear-day'); 
        const toastEl = document.getElementById('toast');
        const lastSaveEl = document.getElementById('last-save');
        let lastDate = '';
        let toastTimer = null;
        let debounceTimer = null;

        // --- è¾…åŠ©å‡½æ•° ---
        const showToast = (msg) => {
            if (!toastEl) return;
            toastEl.textContent = msg;
            toastEl.classList.add('show');
            clearTimeout(toastTimer);
            toastTimer = setTimeout(() => toastEl.classList.remove('show'), 1400);
        };

        const readStore = () => {
            try {
                const cached = localStorage.getItem(storageKey);
                return cached ? JSON.parse(cached) : {};
            } catch (e) {
                console.warn('è¯»å–ç¼“å­˜å¤±è´¥', e);
                return {};
            }
        };

        const writeStore = (data) => {
            localStorage.setItem(storageKey, JSON.stringify(data));
        };

        const getCurrentDate = () => dateInput?.value || '';

        const clearFields = () => fields.forEach(el => {
            if (el.name === 'date') return;
            if (el.type === 'range') {
                el.value = '5';
                updateRangeValue(el.id);
            } else {
                el.value = '';
            }
        });

        const formatDate = (date) => {
            const d = new Date(date);
            // ä¿®æ­£ï¼šç¡®ä¿æ—¥æœŸæ­£ç¡®åç§»ï¼Œé¿å…æ—¶åŒºé—®é¢˜å¯¼è‡´æ—¥æœŸé”™è¯¯ï¼ˆå°¤å…¶æ˜¯é’ˆå¯¹ YYYY-MM-DD æ ¼å¼ï¼‰
            const offset = d.getTimezoneOffset() * 60000;
            const localDate = new Date(d.getTime() - offset);
            
            const yyyy = localDate.getFullYear();
            const mm = String(localDate.getMonth() + 1).padStart(2, '0');
            const dd = String(localDate.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        };

        const updateRangeValue = (id) => {
            const range = document.getElementById(id);
            const valueDisplay = document.getElementById(id.replace('-range', '-value'));
            if (range && valueDisplay) {
                valueDisplay.textContent = range.value;
            }
        };

        /**
         * æ£€æŸ¥æ—¥æœŸæ˜¯å¦æ˜¯æœªæ¥æ—¥æœŸï¼ˆå¤§äºä»Šå¤©ï¼‰ã€‚
         * @param {string} dateStr - æ ¼å¼ä¸º YYYY-MM-DD çš„æ—¥æœŸå­—ç¬¦ä¸²
         * @returns {boolean}
         */
        const isFutureDate = (dateStr) => {
            if (!dateStr) return false;
            // ç¡®ä¿è·å–ä»Šå¤©çš„æ—¥æœŸæ—¶æ²¡æœ‰æ—¶é—´æˆ³ï¼Œä»¥ä¾¿è¿›è¡Œçº¯æ—¥æœŸæ¯”è¾ƒ
            const today = formatDate(new Date()); 
            return dateStr > today;
        };

        // --- Core fields for recording significance check ---
        // ä¿®æ­£ï¼šå®šä¹‰æ‰€æœ‰è¢«è®¤ä¸ºæ˜¯â€œè®°å½•è¡Œä¸ºâ€çš„å­—æ®µ (ä¸åŒ…å« mood/energy)
        const importantLogFields = [
            'sleepStart', 'sleepEnd', 'happy1', 'happy2', 'happy3', 
            'action', 'selflove', 'trigger', 'rescue', 'spendTotal', 
            'spendEmo', 'spendValue', 'todo1', 'todo2', 'todo3'
        ];

        /**
         * æ£€æŸ¥å½“å‰æ•°æ®æ˜¯å¦æ„æˆâ€œæœ‰æ•ˆè®°å½•â€
         * åˆ¤å®šæ ‡å‡†ï¼šè¯„åˆ†åç¦»é»˜è®¤å€¼ 5 OR å¡«å†™äº†ä»»ä½•ä¸€ä¸ªå…³é”®æ•°æ®é¡¹ (ç¡çœ /å¼€å¿ƒäº‹ç­‰)
         * @param {Object} payload - å½“å‰æ—¥æœŸçš„æ‰€æœ‰æ•°æ®
         * @returns {boolean}
         */
        const isRecordSignificant = (payload) => {
            // 1. æ£€æŸ¥è¯„åˆ†æ˜¯å¦åç¦»é»˜è®¤å€¼ 5
            const scoresDeviate = payload.mood !== '5' || payload.energy !== '5';

            // 2. æ£€æŸ¥å…³é”®å­—æ®µæ˜¯å¦æœ‰å¡«å†™
            const hasKeyData = importantLogFields.some(key => {
                const value = payload[key];
                // ç¡®ä¿å€¼å­˜åœ¨ä¸”éç©ºå­—ç¬¦ä¸²/éä»…ç©ºæ ¼
                return value && String(value).trim() !== '';
            });
            
            return scoresDeviate || hasKeyData;
        };
        
        // --- æ ¸å¿ƒé€»è¾‘å‡½æ•° ---
        
        /**
         * æ£€æŸ¥ç›®æ ‡æ—¥æœŸæ˜¯å¦ä¸ºæœªæ¥ï¼Œå¹¶æ ¹æ®ç»“æœç¦ç”¨/å¯ç”¨è¾“å…¥å­—æ®µå’ŒæŒ‰é’®
         * @param {string} targetDate 
         */
        const checkFutureDateAndDisable = (targetDate) => {
            const isFuture = isFutureDate(targetDate);
            const isToday = targetDate === formatDate(new Date());
            
            // 1. ç¦ç”¨/å¯ç”¨æ‰€æœ‰è¾“å…¥å­—æ®µ
            fields.forEach(el => {
                el.disabled = isFuture;
            });

            // 2. ç¦ç”¨/å¯ç”¨å¯¼èˆªæŒ‰é’®å’Œæ¸…ç©ºæŒ‰é’®
            if (nextDayBtn) {
                // å¦‚æœæ˜¯ä»Šå¤©æˆ–æœªæ¥æ—¥æœŸï¼Œç¦ç”¨â€œåä¸€å¤©â€æŒ‰é’®
                nextDayBtn.disabled = isToday || isFuture;
            }
            if (clearDayBtn) {
                // æœªæ¥æ—¥æœŸä¸èƒ½æ¸…ç©ºï¼ˆå› ä¸ºå®ƒæœ¬èº«å°±æ˜¯ç©ºçš„ï¼‰
                clearDayBtn.disabled = isFuture;
            }

            // 3. æ›´æ–°çŠ¶æ€æç¤º
            if (isFuture) {
                dateStatus.innerHTML = `<span style="color: #ef4444; font-weight: bold;">æœªæ¥æ—¥æœŸï¼š${targetDate}ã€‚æ— æ³•å¡«å†™ã€‚</span>`;
                // ç¡®ä¿æ¸…ç©ºå­—æ®µï¼Œæœªæ¥æ—¥æœŸæ— æ•°æ®
                clearFields();
                if (lastSaveEl) lastSaveEl.textContent = '';
                return true;
            }
            return false;
        };


        const loadData = (targetDate = getCurrentDate()) => {
            if (dateInput) dateInput.value = targetDate;
            
            // ä¼˜å…ˆæ£€æŸ¥å¹¶å¤„ç†æœªæ¥æ—¥æœŸ
            if (checkFutureDateAndDisable(targetDate)) {
                generateSummaryChart(readStore());
                renderCalendar(currentMonth, readStore()); // é‡æ–°æ¸²æŸ“æ—¥å†ä»¥æ›´æ–°çŠ¶æ€
                return;
            }

            // å¦‚æœæ˜¯ä»Šå¤©æˆ–è¿‡å»ï¼ŒåŠ è½½æ•°æ®
            const store = readStore();
            clearFields();
            const data = store[targetDate] || {};
            fields.forEach(el => {
                if (data[el.name] !== undefined) {
                    el.value = data[el.name];
                    if (el.type === 'range') {
                        updateRangeValue(el.id);
                    }
                }
            });
            // ä¿®æ­£ï¼šå¦‚æœåŠ è½½çš„è®°å½•æ˜¯æ— æ•ˆè®°å½•ï¼ˆç†è®ºä¸Š saveData å·²åˆ é™¤ï¼‰ï¼Œä¹Ÿæ˜¾ç¤ºæ— è®°å½•
            const hasData = !!store[targetDate] && isRecordSignificant(store[targetDate]);
            updateStatus(targetDate, hasData, data.updatedAt);
            generateSummaryChart(store); 
            // åœ¨ loadData ç»“æŸæ—¶é‡æ–°æ¸²æŸ“æ—¥å†ï¼Œç¡®ä¿é€‰ä¸­çŠ¶æ€æ­£ç¡®
            renderCalendar(currentMonth, store); 
        };

        const saveData = (targetDate = getCurrentDate(), silent = false) => {
            if (!targetDate || isFutureDate(targetDate)) return; // é˜»æ­¢ä¿å­˜æœªæ¥æ—¥æœŸ

            const store = readStore();
            const payload = {};
            // åªæœ‰å½“å­—æ®µæ²¡æœ‰è¢«ç¦ç”¨æ—¶æ‰å°è¯•è·å–å…¶å€¼
            fields.forEach(el => {
                if (!el.disabled) { 
                    payload[el.name] = el.value;
                }
            });

            // ç¡®ä¿ mood å’Œ energy è‡³å°‘æœ‰é»˜è®¤å€¼ 5 (å¦‚æœç”¨æˆ·æ¸…ç©ºäº†å®ƒä»¬)
            if (!payload.mood) payload.mood = '5';
            if (!payload.energy) payload.energy = '5';

            // *** æ ¸å¿ƒä¿®æ­£ï¼šåªæœ‰æ•°æ®æœ‰æ„ä¹‰æ—¶æ‰ä¿å­˜æˆ–æ›´æ–° ***
            if (isRecordSignificant(payload)) {
                payload.date = targetDate;
                payload.updatedAt = Date.now();
                store[targetDate] = payload;
                writeStore(store);
                updateStatus(targetDate, true, payload.updatedAt);
                if (!silent) showToast('å·²è‡ªåŠ¨ä¿å­˜');
            } else {
                // å¦‚æœæ•°æ®ä¸é‡è¦ï¼Œä¸” store ä¸­å­˜åœ¨è¿™æ¡è®°å½•ï¼Œåˆ™åˆ é™¤å®ƒ
                if (store[targetDate]) {
                    delete store[targetDate];
                    writeStore(store);
                    updateStatus(targetDate, false, undefined);
                    if (!silent) showToast('å·²æ¸…ç©ºï¼ˆæ— æœ‰æ•ˆè®°å½•ï¼‰');
                } else {
                     updateStatus(targetDate, false, undefined); // ä»…æ›´æ–°çŠ¶æ€
                }
            }
            
            generateSummaryChart(store); 
            renderCalendar(currentMonth, store); // é‡æ–°æ¸²æŸ“æ—¥å†ä»¥æ›´æ–°çŠ¶æ€
        };

        const handleDateChange = (newDate) => {
            if (!newDate) return;
            // ç¡®ä¿åœ¨åˆ‡æ¢æ—¥æœŸå‰ï¼Œå½“å‰æ—¥æœŸçš„æ•°æ®è¢«ä¿å­˜ (åŒæ­¥é™é»˜ä¿å­˜)
            saveData(lastDate || getCurrentDate(), true); 
            lastDate = newDate;
            loadData(newDate); 
        };

        const shiftDate = (delta) => {
            // ä¿®æ­£ï¼šç¡®ä¿ç”¨ new Date(dateInput.value) åˆ›å»ºçš„æ—¥æœŸå¯¹è±¡æ˜¯å‡†ç¡®çš„ï¼Œé¿å…æ—¶åŒºè¯¯å·®
            const base = dateInput.value ? new Date(dateInput.value.replace(/-/g, '/')) : new Date(); 
            base.setDate(base.getDate() + delta);
            const next = formatDate(base);
            handleDateChange(next);
        };

        const goToday = () => {
            handleDateChange(formatDate(new Date()));
        };

        const clearCurrent = () => {
            const current = getCurrentDate();
            if (!current || isFutureDate(current)) return; 
            
            if (!confirm(`ç¡®å®šè¦æ¸…ç©º ${current} çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) return;
            
            const store = readStore();
            delete store[current];
            writeStore(store);
            clearFields();
            updateStatus(current, false, undefined);
            generateSummaryChart(store);
            renderCalendar(currentMonth, store); // é‡æ–°æ¸²æŸ“æ—¥å†ä»¥æ›´æ–°çŠ¶æ€
            showToast('å·²æ¸…ç©ºå½“å‰æ—¥æœŸæ•°æ®');
        };

        // ä¿®æ­£ 2: æ›´æ–°æ—¶é—´æ ¼å¼ï¼ŒåŒ…å«å¹´æœˆæ—¥å’Œæ—¶é—´
        const updateStatus = (date, hasData, updatedAt) => {
            if (!dateStatus) return;
            dateStatus.textContent = hasData ? `å·²åŠ è½½ï¼š${date}` : `å½“å‰æ—¥æœŸæš‚æ— è®°å½•ï¼š${date}`;
            if (lastSaveEl) {
                if (updatedAt) {
                    const d = new Date(updatedAt);
                    const YYYY = d.getFullYear();
                    const MM = String(d.getMonth() + 1).padStart(2, '0');
                    const DD = String(d.getDate()).padStart(2, '0');
                    const hh = String(d.getHours()).padStart(2, '0');
                    const mm = String(d.getMinutes()).padStart(2, '0');
                    
                    // ä¿®æ­£ï¼šåŒ…å«å¹´æœˆæ—¥å’Œæ—¶é—´
                    lastSaveEl.textContent = `æœ€è¿‘ä¿å­˜ï¼š${YYYY}-${MM}-${DD} ${hh}:${mm}`;
                } else {
                    lastSaveEl.textContent = '';
                }
            }
        };

        // --- æ•°æ®æ€»è§ˆå›¾è¡¨ç”Ÿæˆ (ä¿æŒä¸å˜) ---
        const generateSummaryChart = (store) => {
            const chartContainer = document.getElementById('chart-container');
            if (!chartContainer) return;
            const maxBarHeight = 100;

            const allDates = Object.keys(store).filter(d => d);
            allDates.sort((a, b) => new Date(a) - new Date(b));
            const last7Days = allDates.slice(-7); 

            chartContainer.innerHTML = ''; 

            if (last7Days.length === 0) {
                chartContainer.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 30px 0; width: 100%;">æš‚æ— æœ€è¿‘çš„è®°å½•æ•°æ®ã€‚</div>';
                return;
            }

            const refLines = [
                { score: 10, label: '10' },
                { score: 5, label: '5' }
            ];
            
            refLines.forEach(ref => {
                const refLine = document.createElement('div');
                refLine.className = 'chart-ref-line';
                refLine.style.bottom = `${(ref.score / 10) * maxBarHeight}px`; 

                const refLabel = document.createElement('span');
                refLabel.className = 'ref-label';
                refLabel.textContent = ref.label;
                refLabel.style.bottom = `${(ref.score / 10) * maxBarHeight}px`;

                chartContainer.appendChild(refLine);
                chartContainer.appendChild(refLabel);
            });

            last7Days.forEach(dateStr => {
                const data = store[dateStr];
                // åªæœ‰æœ‰æ•ˆçš„è®°å½•æ‰æ˜¾ç¤ºåœ¨å›¾è¡¨ä¸Š
                if (!data || !isRecordSignificant(data)) return; 
                
                const moodScore = Math.min(10, Math.max(0, parseInt(data.mood, 10) || 0));
                const energyScore = Math.min(10, Math.max(0, parseInt(data.energy, 10) || 0));
                const dateLabel = dateStr.substring(5); 

                const dayChart = document.createElement('div');
                dayChart.className = 'day-chart';

                const barGroup = document.createElement('div');
                barGroup.className = 'bar-group';

                const moodHeight = moodScore * 10; 
                const moodBar = document.createElement('div');
                moodBar.className = 'chart-bar chart-bar-mood';
                moodBar.style.height = `${moodHeight}px`;
                
                const energyHeight = energyScore * 10;
                const energyBar = document.createElement('div');
                energyBar.className = 'chart-bar chart-bar-energy';
                energyBar.style.height = `${energyHeight}px`;

                // å³ä½¿æ˜¯ 5 åˆ†ï¼Œåªè¦æ˜¯æœ‰æ•ˆè®°å½•ï¼Œä¹Ÿåº”è¯¥æ˜¾ç¤ºåˆ†æ•°
                if (moodScore > 0) { 
                    const moodLabel = document.createElement('div');
                    moodLabel.className = 'score-label mood-label';
                    moodLabel.textContent = moodScore;
                    moodLabel.style.bottom = `${moodHeight}px`; 
                    barGroup.appendChild(moodLabel);
                }

                if (energyScore > 0) {
                    const energyLabel = document.createElement('div');
                    energyLabel.className = 'score-label energy-label';
                    energyLabel.textContent = energyScore;
                    energyLabel.style.bottom = `${energyHeight}px`;
                    barGroup.appendChild(energyLabel);
                }
                
                barGroup.appendChild(moodBar);
                barGroup.appendChild(energyBar);

                const label = document.createElement('div');
                label.className = 'chart-label';
                label.textContent = dateLabel;

                dayChart.appendChild(barGroup);
                dayChart.appendChild(label);
                chartContainer.appendChild(dayChart);
            });
        };
        
        // --- å¯¼å‡ºé€»è¾‘ (å·²ä¿®æ­£æ–‡æœ¬) ---
        const downloadFile = (filename, content) => {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        };

        const toMarkdown = () => {
            const get = name => document.querySelector(`[name="${name}"]`)?.value || '';
            const dateStr = get('date') || 'æœªå¡«æ—¥æœŸ';
            const lines = [
                `# æ¯æ—¥æƒ…ç»ªä¸æŒæ§æ„Ÿè®°å½•`,
                `- æ—¥æœŸ: ${dateStr}`,
                `- æƒ…ç»ªè¯„åˆ†: ${get('mood')}`,
                `- èƒ½é‡è¯„åˆ†: ${get('energy')}`,
                `- ç¡çœ : ${get('sleepStart')} - ${get('sleepEnd')}`,
                ``,
                `## ä»Šæ—¥æœ€å¼€å¿ƒçš„ä¸‰ä»¶äº‹`,
                `1. ${get('happy1')}`,
                `2. ${get('happy2')}`,
                `3. ${get('happy3')}`,
                ``,
                // æ–‡æœ¬ä¿®æ”¹ 2: ä»Šæ—¥çš„æŒæ§æ„Ÿ
                `## ä»Šæ—¥çš„æŒæ§æ„Ÿ`, 
                `${get('action')}`,
                ``,
                // æ–‡æœ¬ä¿®æ”¹ 3: ä»Šæ—¥çš„è‡ªçˆ±è¡ŒåŠ¨
                `## ä»Šæ—¥çš„è‡ªçˆ±è¡ŒåŠ¨`, 
                `${get('selflove')}`,
                ``,
                // æ–‡æœ¬ä¿®æ”¹ 4: æƒ…ç»ªè§¦å‘ç‚¹
                `## æƒ…ç»ªè§¦å‘ç‚¹`, 
                `${get('trigger')}`,
                ``,
                `## è‡ªæ•‘è¡Œä¸º`, 
                `${get('rescue')}`,
                ``,
                `## æ¶ˆè´¹é€Ÿè§ˆ`, 
                `- æ€»é¢: ${get('spendTotal')}`,
                // å¯¼å‡ºæ–‡æœ¬å·²æ›´æ–°ä¸ºâ€œæŠ•èµ„æ€§æ¶ˆè´¹â€
                `- æƒ…ç»ªæ€§æ¶ˆè´¹: ${get('spendEmo')}`,
                `- æŠ•èµ„æ€§æ¶ˆè´¹: ${get('spendValue')}`, 
                ``,
                `## æ˜å¤©ä¸‰ä»¶å°äº‹`,
                `1. ${get('todo1')}`,
                `2. ${get('todo2')}`,
                `3. ${get('todo3')}`
            ];
            downloadFile(`daily-record-${dateStr}.md`, lines.join('\n'));
        };

        const toTXT = () => {
            const get = name => document.querySelector(`[name="${name}"]`)?.value || '';
            const dateStr = get('date') || 'æœªå¡«æ—¥æœŸ';
            const lines = [
                `æ—¥æœŸ: ${dateStr}`,
                `æƒ…ç»ªè¯„åˆ†: ${get('mood')}`,
                `èƒ½é‡è¯„åˆ†: ${get('energy')}`,
                `ç¡çœ : ${get('sleepStart')} - ${get('sleepEnd')}`,
                ``,
                `æœ€å¼€å¿ƒçš„ä¸‰ä»¶äº‹:`,
                `1) ${get('happy1')}`,
                `2) ${get('happy2')}`,
                `3) ${get('happy3')}`,
                ``,
                // æ–‡æœ¬ä¿®æ”¹ 2: ä»Šæ—¥çš„æŒæ§æ„Ÿ
                `ä»Šæ—¥çš„æŒæ§æ„Ÿ:`, 
                `${get('action')}`,
                ``,
                // æ–‡æœ¬ä¿®æ”¹ 3: ä»Šæ—¥çš„è‡ªçˆ±è¡ŒåŠ¨
                `ä»Šæ—¥çš„è‡ªçˆ±è¡ŒåŠ¨:`, 
                `${get('selflove')}`,
                ``,
                // æ–‡æœ¬ä¿®æ”¹ 4: æƒ…ç»ªè§¦å‘ç‚¹
                `æƒ…ç»ªè§¦å‘ç‚¹:`, 
                `${get('trigger')}`,
                ``,
                `è‡ªæ•‘è¡Œä¸º:`, 
                `${get('rescue')}`,
                ``,
                `æ¶ˆè´¹é€Ÿè§ˆ:`, 
                `æ€»é¢: ${get('spendTotal')}`,
                // å¯¼å‡ºæ–‡æœ¬å·²æ›´æ–°ä¸ºâ€œæŠ•èµ„æ€§æ¶ˆè´¹â€
                `æƒ…ç»ªæ€§æ¶ˆè´¹: ${get('spendEmo')}`,
                `æŠ•èµ„æ€§æ¶ˆè´¹: ${get('spendValue')}`,
                ``,
                `æ˜å¤©ä¸‰ä»¶å°äº‹:`,
                `1) ${get('todo1')}`,
                `2) ${get('todo2')}`,
                `3) ${get('todo3')}`
            ];
            downloadFile(`daily-record-${dateStr}.txt`, lines.join('\n'));
        };

        // --- æ—¥å†ç”Ÿæˆé€»è¾‘ ---
        const todayDate = formatDate(new Date());
        // ä½¿ç”¨ä¸€ä¸ªåŸºå‡†æ—¥æœŸå¯¹è±¡æ¥æ§åˆ¶æ—¥å†çš„æœˆä»½
        let currentMonth = new Date(); 

        /**
         * æ¸²æŸ“æ—¥å†ç½‘æ ¼
         * @param {Date} dateObj - åŒ…å«ç›®æ ‡å¹´æœˆä¿¡æ¯çš„ Date å¯¹è±¡
         * @param {Object} store - æ‰€æœ‰è®°å½•æ•°æ®çš„å¯¹è±¡
         */
        const renderCalendar = (dateObj, store) => {
            const grid = document.getElementById('calendar-grid');
            const monthYearDisplay = document.getElementById('current-month-year');
            if (!grid || !monthYearDisplay) return;

            // æ¸…ç©ºæ—§çš„æ—¥æœŸå•å…ƒæ ¼ï¼Œä¿ç•™æ˜ŸæœŸæ ‡é¢˜ï¼ˆå‰ 7 ä¸ªæ˜¯æ˜ŸæœŸåï¼‰
            while (grid.children.length > 7) {
                grid.removeChild(grid.lastChild);
            }

            const year = dateObj.getFullYear();
            const month = dateObj.getMonth(); // 0-11
            const currentDate = getCurrentDate(); // è·å–å½“å‰åŠ è½½çš„æ—¥æœŸ

            // è®¾ç½®æ ‡é¢˜
            monthYearDisplay.textContent = `${year} å¹´ ${month + 1} æœˆ`;

            // 1. è®¡ç®—ç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡  (0=æ—¥, 6=å…­)
            const firstDayOfMonth = new Date(year, month, 1);
            const startingDay = firstDayOfMonth.getDay(); // è·å–æ˜ŸæœŸå‡  (0-6)

            // 2. è®¡ç®—æœ¬æœˆæœ‰å¤šå°‘å¤©
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();

            // 3. å¡«å……ç©ºç™½æ ¼ (ä¸Šä¸ªæœˆçš„æ—¥æœŸ)
            for (let i = 0; i < startingDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day empty-day';
                grid.appendChild(emptyCell);
            }
            
            // 4. å¡«å……æœ¬æœˆçš„æ—¥æœŸ
            for (let day = 1; day <= daysInMonth; day++) {
                // ä¿®æ­£ï¼šç¡®ä¿æ—¥æœŸå­—ç¬¦ä¸²æ˜¯å‡†ç¡®çš„ YYYY-MM-DD æ ¼å¼ï¼Œé¿å…æ—¶åŒºé—®é¢˜
                const d = new Date(year, month, day); 
                const dateStr = formatDate(d);

                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.textContent = day;
                dayCell.setAttribute('data-date', dateStr);
                
                // æ ‡è®°ä»Šå¤©
                if (dateStr === todayDate) {
                    dayCell.classList.add('today');
                }
                
                // æ ‡è®°å½“å‰åŠ è½½çš„æ—¥æœŸ
                if (dateStr === currentDate) {
                    dayCell.classList.add('selected-day');
                }

                // *** æ ¸å¿ƒä¿®æ­£ï¼šæ ‡è®°å·²è®°å½•æ—¥æœŸï¼ˆä½¿ç”¨æ–°çš„ç»Ÿä¸€åˆ¤å®šé€»è¾‘ï¼‰ ***
                const record = store[dateStr];
                
                // å¦‚æœå­˜åœ¨è®°å½•ï¼Œä¸”è¯¥è®°å½•æ˜¯æœ‰æ•ˆçš„
                if (record && isRecordSignificant(record)) {
                    // é¿å…è¢«é€‰ä¸­çŠ¶æ€è¦†ç›–recordedçš„æ ·å¼ï¼Œä½†åŒæ—¶ä¿ç•™è¢«é€‰ä¸­çŠ¶æ€
                    if (!dayCell.classList.contains('selected-day')) {
                         dayCell.classList.add('recorded');
                    }
                   
                    const mark = document.createElement('span');
                    mark.className = 'recorded-mark';
                    mark.textContent = 'âœ…'; 
                    dayCell.appendChild(mark);
                }

                // æ·»åŠ ç‚¹å‡»è·³è½¬äº‹ä»¶
                dayCell.addEventListener('click', (e) => {
                    const targetDate = e.currentTarget.getAttribute('data-date');
                    // åªæœ‰éç©ºæ—¥æœŸæ ¼æ‰è§¦å‘è·³è½¬
                    if (targetDate && !e.currentTarget.classList.contains('empty-day')) { 
                        handleDateChange(targetDate);
                        // å¯é€‰ï¼šæ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨ï¼Œä»¥ä¾¿ç”¨æˆ·çœ‹åˆ°æ—¥æœŸåˆ‡æ¢åçš„å†…å®¹
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                });

                grid.appendChild(dayCell);
            }
        };

        const shiftCalendarMonth = (delta) => {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar(currentMonth, readStore());
        };

        // --- åˆå§‹åŒ–å‡½æ•° ---
        const init = () => {
            const today = formatDate(new Date());
            if (!dateInput.value) {
                dateInput.value = today;
            }
            
            // è¿ç§»æ—§æ•°æ®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (!localStorage.getItem(storageKey) && localStorage.getItem('daily-record-v1')) {
                try {
                    const legacyData = JSON.parse(localStorage.getItem('daily-record-v1'));
                    writeStore({ [today]: { ...legacyData, date: today } });
                    localStorage.removeItem('daily-record-v1');
                } catch (e) {
                    console.warn('è¿ç§»æ—§æ•°æ®å¤±è´¥', e);
                }
            }

            // åˆå§‹åŒ–æ»‘å—æ•°å€¼æ˜¾ç¤º
            updateRangeValue('mood-range');
            updateRangeValue('energy-range');

            // åŠ è½½åˆå§‹æ•°æ®
            lastDate = getCurrentDate();
            // åˆå§‹åŠ è½½æ•°æ® (ç¡®ä¿ selected-day æ ‡è®°æ­£ç¡®)
            loadData(lastDate);

            // ç›‘å¬äº‹ä»¶
            fields.forEach(el => el.addEventListener('input', (e) => {
                if (e.target.type === 'range') {
                    updateRangeValue(e.target.id);
                }
                
                // å¦‚æœæ˜¯æœªæ¥æ—¥æœŸï¼Œåˆ™ä¸å…è®¸ä¿å­˜
                if (isFutureDate(getCurrentDate())) return; 
                
                // ç«‹å³é™é»˜ä¿å­˜ï¼Œå¹¶è®¾ç½®é˜²æŠ–ä¿å­˜
                saveData(getCurrentDate(), true);
                clearTimeout(debounceTimer);
                // 1200ms åè¿›è¡Œéé™é»˜ä¿å­˜ï¼ŒåŒæ—¶æ›´æ–°æ—¥å†çŠ¶æ€
                debounceTimer = setTimeout(() => saveData(getCurrentDate(), false), 1200); 
            }));
            
            ['change', 'input'].forEach(evt => {
                dateInput.addEventListener(evt, (e) => handleDateChange(e.target.value));
            });

            document.getElementById('prev-day').addEventListener('click', () => shiftDate(-1));
            document.getElementById('next-day').addEventListener('click', () => shiftDate(1));
            document.getElementById('goto-today').addEventListener('click', goToday);
            document.getElementById('clear-day').addEventListener('click', clearCurrent);
            document.getElementById('export-md').addEventListener('click', toMarkdown);
            document.getElementById('export-txt').addEventListener('click', toTXT);
            document.getElementById('print-page').addEventListener('click', () => window.print());

            // --- æ—¥å†åˆå§‹åŒ–å’Œäº‹ä»¶ç»‘å®š ---
            
            // ç»‘å®šæ—¥å†æœˆä»½åˆ‡æ¢æŒ‰é’®
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            if (prevMonthBtn) {
                prevMonthBtn.addEventListener('click', () => shiftCalendarMonth(-1));
            }
            if (nextMonthBtn) {
                nextMonthBtn.addEventListener('click', () => shiftCalendarMonth(1));
            }
        };

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>