<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mood Control Log</title>
    <style>
        /* æ ·å¼ä¼˜åŒ–ï¼šæ›´æŸ”å’Œçš„é…è‰²ã€åœ†è§’ã€é˜´å½± */
        body { font-family: 'Arial', 'Microsoft YaHei', sans-serif; line-height: 1.6; max-width: 880px; margin: 25px auto; padding: 0 18px; background-color: #f0f2f5; }
        h2 { border-bottom: 3px solid #b3cde0; padding-bottom: 8px; color: #1e3a8a; text-align: center; margin-bottom: 22px; }
        h3 { color: #1f4b99; margin-top: 22px; border-left: 5px solid #4f8ef5; padding-left: 10px; }
        .section { margin-bottom: 26px; padding: 18px; border: 1px solid #d7dce3; background-color: #ffffff; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); }
        table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        th, td { border: 1px solid #e5e7eb; padding: 10px; text-align: left; vertical-align: top; }
        th { background-color: #e8f0ff; color: #1e3a8a; font-weight: 700; }
        input[type="text"], input[type="date"], input[type="number"], select, input[type="time"] { width: 100%; max-width: 460px; padding: 7px 9px; border: 1px solid #c5ccd6; border-radius: 6px; box-sizing: border-box; transition: border-color 0.3s, box-shadow 0.2s; background: #fff; font-family: inherit; white-space: normal; word-break: break-word; line-height: 1.3; min-height: 28px; }
        input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, input[type="time"]:focus, textarea:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); }
        input[type="date"], input[type="time"] { max-width: 220px; padding: 8px; }
        textarea { width: 100%; min-height: 52px; padding: 8px 9px; border: 1px solid #c5ccd6; border-radius: 6px; box-sizing: border-box; resize: vertical; font-family: inherit; white-space: pre-wrap; word-break: break-word; line-height: 1.35; }
        /* ç¦ç”¨çŠ¶æ€çš„æ ·å¼ */
        input[disabled], textarea[disabled], input[type="range"][disabled] {
            cursor: not-allowed;
            background-color: #f7f7f7 !important;
            border-color: #e5e7eb !important;
            color: #9ca3af;
        }
        input[type="range"][disabled]::-webkit-slider-thumb {
            background: #aeb5c2 !important;
            box-shadow: none !important;
        }

        ::placeholder { font-family: inherit; color: #9ca3af; opacity: 1; white-space: normal; word-break: break-word; line-height: 1.3; }
        .mobile-hint { display: none; color: #6b7280; font-size: 0.9em; margin-top: 4px; }
        .note { font-size: 0.9em; color: #5f6673; margin-top: 5px; display: block; }
        .mindset { background-color: #dbeafe; border-left: 5px solid #1e3a8a; padding: 15px; margin-top: 20px; border-radius: 5px; }
        .mindset p { margin: 5px 0; color: #1e3a8a; }
        .mindset strong { font-size: 1.1em; }
        .actions { display: flex; flex-wrap: wrap; gap: 10px; margin: 14px 0 6px; }
        .date-row { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; }
        .date-status { font-size: 0.9em; color: #374151; }
        .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; background-color: #2563eb; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95em; box-shadow: 0 3px 8px rgba(37, 99, 235, 0.25); transition: transform 0.1s ease, background-color 0.2s; }
        .btn:hover { background-color: #1d4ed8; }
        .btn:active { transform: translateY(1px); }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; box-shadow: none; transform: none; }
        .btn.secondary { background-color: #6b7280; box-shadow: 0 3px 8px rgba(107, 114, 128, 0.25); }
        .btn.secondary:hover { background-color: #4b5563; }
        .btn.secondary:disabled { background-color: #9ca3af; }
        .inline-hint { font-size: 0.9em; color: #4b5563; margin-top: 4px; }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; margin-top: 10px; }
        .metric { border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; background: #f9fafb; box-shadow: 0 2px 4px rgba(0,0,0,0.04); }
        .metric-label { display: flex; align-items: center; gap: 8px; font-weight: 700; color: #1e3a8a; }
        .metric-body { font-size: 0.95em; color: #374151; margin: 6px 0 10px; }
        .metric-score { max-width: 100%; }
        .inline-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin: 4px 0; }
        .inline-label { white-space: nowrap; font-weight: 600; color: #1e3a8a; }
        .inline-row textarea, .inline-row input { flex: 1 1 0; min-width: 0; }
        .btn.ghost { background: #eef2ff; color: #1e3a8a; box-shadow: none; }
        .btn.ghost:hover { background: #dbeafe; }
        .btn.ghost:disabled { background-color: #e5e7eb; color: #9ca3af; }
        .toast { position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%); background: rgba(31,41,55,0.9); color: #fff; padding: 10px 14px; border-radius: 8px; box-shadow: 0 8px 20px rgba(0,0,0,0.18); font-size: 0.95em; opacity: 0; pointer-events: none; transition: opacity 0.2s ease; z-index: 9999; }
        .toast.show { opacity: 1; }
        .last-save { font-size: 0.9em; color: #4b5563; margin-left: 8px; }
        h4 { margin: 10px 0 6px; }
        .note { margin-top: 2px; }
        /* è¯„åˆ†æ»‘å—æ ·å¼ - ä»…ä¿ç•™ 1 å’Œ 10 æ ‡ç­¾ */
        .rating-labels { display: flex; justify-content: space-between; font-size: 0.9em; color: #6b7280; padding: 0 2px; margin-top: 2px; font-weight: bold; }
        .rating-value { font-weight: 700; color: #1e3a8a; text-align: center; margin-top: 4px; font-size: 1.1em; }
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #e0e7ff; border-radius: 5px; transition: opacity .2s; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #4f8ef5; cursor: pointer; border: 2px solid #ffffff; box-shadow: 0 0 4px rgba(0, 0, 0, 0.15); }
        input[type="range"]::-moz-range-thumb { width: 18px; height: 18px; border-radius: 50%; background: #4f8ef5; cursor: pointer; border: 2px solid #ffffff; box-shadow: 0 0 4px rgba(0, 0, 0, 0.15); }
        input[type="range"][disabled]::-webkit-slider-thumb { background: #aeb5c2 !important; }

        /* å›¾è¡¨æ ·å¼ */
        #chart-container {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 140px; 
            gap: 10px;
            padding: 10px 0;
            border-bottom: 2px solid #e5e7eb;
            position: relative; 
            padding-left: 20px; 
            box-sizing: content-box;
        }
        .chart-ref-line {
            position: absolute;
            left: 20px; 
            width: calc(100% - 20px);
            border-top: 1px dotted #d1d5db;
        }
        .ref-label {
             position: absolute;
             left: 0px;
             font-size: 0.75em;
             color: #6b7280;
             line-height: 1;
             transform: translateY(-50%); 
             font-weight: 500;
        }
        .day-chart {
            flex: 1 1 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            min-width: 30px;
        }
        .bar-group {
            display: flex;
            align-items: flex-end;
            height: 100px; 
            width: 100%;
            justify-content: center;
            gap: 2px;
            position: relative; 
        }
        .chart-bar {
            width: 45%;
            transition: height 0.3s ease;
            border-radius: 3px 3px 0 0;
            opacity: 0.9;
            min-height: 1px; 
        }
        .chart-bar-mood { background-color: #4f8ef5; } 
        .chart-bar-energy { background-color: #10b981; } 
        .chart-label {
            font-size: 0.8em;
            color: #6b7280;
            margin-top: 5px;
            text-align: center;
        }
        .score-label {
            position: absolute;
            text-align: center;
            font-size: 0.75em; 
            font-weight: bold;
            transition: all 0.3s ease;
            transform: translateY(-100%); 
            line-height: 1;
        }
        .mood-label { 
            left: 5%; 
            width: 45%; 
            color: #1e3a8a; 
        }
        .energy-label { 
            left: 50%; 
            width: 45%; 
            color: #065f46; 
        }

        @media (max-width: 640px) {
            .metrics { grid-template-columns: 1fr; }
            .mobile-hint { display: block; }
            #chart-container { padding-left: 15px; height: 120px; }
            .chart-ref-line { left: 15px; width: calc(100% - 15px); }
            .ref-label { left: 0px; }
            .score-label { font-size: 0.7em; }
        }
    </style>
</head>
<body>

    <h2>âœ¨ æ¯æ—¥æƒ…ç»ªä¸æŒæ§æ„Ÿè®°å½• âœ¨</h2>

    <div class="section mindset">
        <h3>ğŸ’¡ è®°å½•å¿ƒæ³•ï¼šè‡ªæˆ‘å‘µæŠ¤æŒ‡å—</h3>
        <p>1. é™ä½é—¨æ§›ï¼šä»»ä½•ä¸€ç‚¹è®°å½•éƒ½æ¯”å®Œå…¨æ”¾å¼ƒè¦å¥½ã€‚å¦‚æœä»Šå¤©å¾ˆç´¯ï¼Œåªå†™ä¸‹ A1/A2 è¯„åˆ† æˆ– B1 æœ€å¼€å¿ƒçš„äº‹ å³å¯ã€‚</p>
        <p>2. ä¸å¸¦è¯„åˆ¤ï¼šè®°å½•çš„ç›®çš„æ˜¯â€œçœ‹è§â€ï¼ˆå®¢è§‚äº†è§£çŠ¶æ€ï¼‰ï¼Œè€Œä¸æ˜¯â€œå®¡åˆ¤â€ï¼ˆæŒ‡è´£è‡ªå·±ï¼‰ã€‚è¯·å…è®¸æ‰€æœ‰æ„Ÿå—çš„å­˜åœ¨ã€‚</p>
        <p>3. ä¿æŒå¥½å¥‡ï¼šç”¨è§‚å¯Ÿè€…çš„å¿ƒæ€å»è®°å½•ï¼Œå»äº†è§£è‡ªå·±çš„è§„å¾‹å’Œèµ·ä¼ã€‚</p>
    </div>

    <div class="section">
        <h3>ğŸ“… åŸºæœ¬ä¿¡æ¯</h3>
        <div class="date-row">
            <strong>è®°å½•æ—¥æœŸï¼š</strong>
            <input id="date" name="date" type="date" aria-label="è®°å½•æ—¥æœŸ">
            <button class="btn secondary" id="prev-day" type="button">â† å‰ä¸€å¤©</button>
            <button class="btn secondary" id="next-day" type="button">åä¸€å¤© â†’</button>
            <button class="btn ghost" id="goto-today" type="button">å›åˆ°ä»Šå¤©</button>
            <button class="btn ghost" id="clear-day" type="button">æ¸…ç©ºå½“å‰</button>
            <span class="date-status" id="date-status"></span>
            <span class="last-save" id="last-save"></span>
        </div>
        <div class="inline-hint">é»˜è®¤å¡«å…¥ä»Šå¤©ï¼Œåˆ‡æ¢æ—¥æœŸå³å¯æŸ¥çœ‹/å¡«å†™å†å²è®°å½•ã€‚</div>
    </div>

    <div class="section">
        <h3>I. çŠ¶æ€é‡åŒ–ä¸è§‰å¯Ÿ (æ»‘å—ä¼˜åŒ–)</h3>
        <div class="metrics">
            <div class="metric">
                <div class="metric-label">æƒ…ç»ªè¯„åˆ† (1-10)</div>
                <div class="metric-body">ä»Šæ™šå›é¡¾æ—¶çš„æ€»ä½“æƒ…ç»ªï¼Œ1=æåº¦ä½è½ï¼Œ10=æåº¦å…´å¥‹ã€‚</div>
                <div class="rating-value" id="mood-value">5</div>
                <input type="range" min="1" max="10" step="1" value="5" class="metric-score" name="mood" id="mood-range" aria-label="æƒ…ç»ªè¯„åˆ†">
                <div class="rating-labels">
                    <span>1</span>
                    <span>10</span>
                </div>
            </div>
            <div class="metric">
                <div class="metric-label">èƒ½é‡è¯„åˆ† (1-10)</div>
                <div class="metric-body">ä»Šæ™šå›é¡¾æ—¶çš„èº«ä½“ç²¾åŠ›ï¼Œ1=ç–²æƒ«æ— åŠ›ï¼Œ10=å……æ»¡æ´»åŠ›ã€‚</div>
                <div class="rating-value" id="energy-value">5</div>
                <input type="range" min="1" max="10" step="1" value="5" class="metric-score" name="energy" id="energy-range" aria-label="èƒ½é‡è¯„åˆ†">
                <div class="rating-labels">
                    <span>1</span>
                    <span>10</span>
                </div>
            </div>
            <div class="metric">
                <div class="metric-label">ç¡çœ è®°å½• (åŸç”Ÿæ—¶é—´è¾“å…¥)</div>
                <div class="metric-body">è®°å½•æ˜¨æ™šçš„å…¥ç¡ä¸é†’æ¥æ—¶é—´ã€‚</div>
                <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
                    <span>å…¥ç¡ï¼š</span>
                    <input type="time" name="sleepStart" aria-label="å…¥ç¡æ—¶é—´">
                    <span>é†’æ¥ï¼š</span>
                    <input type="time" name="sleepEnd" aria-label="é†’æ¥æ—¶é—´">
                </div>
            </div>
        </div>
    </div>

    <div class="section">
        <h3>II. ç§¯ææ•æ‰ä¸æŒæ§ (è¡ŒåŠ¨èšç„¦)</h3>
        <h4>B1. ä»Šæ—¥æœ€å¼€å¿ƒçš„ä¸‰ä»¶äº‹</h4>
        <div class="note">ï¼ˆç§¯æå¿ƒç†å­¦ç»ƒä¹ ï¼šè®­ç»ƒå¤§è„‘å¯»æ‰¾ç¾å¥½ï¼Œè¶Šå…·ä½“è¶Šå¥½ã€‚ï¼‰</div>
        <div class="inline-row"><span class="inline-label">1.</span><textarea name="happy1" rows="2" placeholder="ä¾‹å¦‚ï¼šé˜³å…‰æ´’åœ¨èº«ä¸Šå¾ˆèˆ’æœ" aria-label="æœ€å¼€å¿ƒçš„äº‹1"></textarea></div>
        <div class="inline-row"><span class="inline-label">2.</span><textarea name="happy2" rows="2" placeholder="ä¾‹å¦‚ï¼šå–åˆ°ä¸€æ¯å¥½å’–å•¡" aria-label="æœ€å¼€å¿ƒçš„äº‹2"></textarea></div>
        <div class="inline-row"><span class="inline-label">3.</span><textarea name="happy3" rows="2" placeholder="ä¾‹å¦‚ï¼šçœ‹åˆ°ä¸€ä¸ªæœ‰è¶£çš„è¡¨æƒ…åŒ…" aria-label="æœ€å¼€å¿ƒçš„äº‹3"></textarea></div>

        <h4>B2. ä»Šæ—¥çš„æŒæ§æ„Ÿä¸è‡ªçˆ±è¡ŒåŠ¨</h4>
        <div class="inline-row">
            <span class="inline-label">å®Œæˆçš„å…·ä½“è¡ŒåŠ¨ï¼š</span>
            <textarea name="action" rows="2" placeholder="ä¾‹å¦‚ï¼šæˆ‘ä¸ºé¢è¯•å‡†å¤‡äº† 1 å°æ—¶ / æˆ‘æŒ‰æ—¶åƒäº†åˆé¥­" aria-label="å®Œæˆçš„å…·ä½“è¡ŒåŠ¨"></textarea>
        </div>
        <div class="inline-row">
            <span class="inline-label">ä»Šæ—¥çš„è‡ªçˆ±è¡ŒåŠ¨ï¼š</span>
            <textarea name="selflove" rows="2" placeholder="ä¾‹å¦‚ï¼šæˆ‘æ²¡æœ‰ç†¬å¤œï¼Œ11ç‚¹å‰èººä¸‹ / æˆ‘ç»™çš®è‚¤æ¶‚äº†ä¹³æ¶²" aria-label="ä»Šæ—¥çš„è‡ªçˆ±è¡ŒåŠ¨"></textarea>
        </div>
    </div>

    <div class="section">
        <h3>III. è§‰å¯Ÿä¸åæ€ (æ·±å±‚æ¢ç´¢)</h3>
        <h4>C1. æƒ…ç»ª/å‹åŠ›è§¦å‘ç‚¹</h4>
        <div class="note"><strong>âš ï¸ é‡ç‚¹ï¼š</strong> å¦‚æœæƒ…ç»ªè¯„åˆ†ä½äº 5 åˆ†ï¼Œè¯·è®°å½•å¯¼è‡´æƒ…ç»ªä¸‹æ»‘çš„äº‹ä»¶ã€æƒ³æ³•æˆ–èº«ä½“æ„Ÿå—ã€‚</div>
        <textarea name="trigger" placeholder="ä¾‹å¦‚ï¼šé¢è¯•å®˜çš„ä¸€ä¸ªé—®é¢˜è®©æˆ‘è§‰å¾—è‡ªå·±èƒ½åŠ›å¾ˆå·®ï¼Œçªç„¶å¼€å§‹å¦å®šè‡ªå·±ã€‚" aria-label="æƒ…ç»ªå‹åŠ›è§¦å‘ç‚¹"></textarea>

        <h4>C2. ä»Šæ—¥æ¶ˆè´¹é€Ÿè§ˆ (æ§åˆ¶æ„Ÿè¾…åŠ©)</h4>
        <p><strong>æ€»é¢ï¼š</strong> Â¥ <input name="spendTotal" type="number" step="0.01" min="0" placeholder="ä¾‹å¦‚ï¼š128.5" aria-label="ä»Šæ—¥æ¶ˆè´¹æ€»é¢"></p>
        <div class="inline-row">
            <span class="inline-label">æƒ…ç»ªæ€§æ¶ˆè´¹ (å¦‚æœæœ‰)ï¼š</span>
            <textarea name="spendEmo" placeholder="å› ç„¦è™‘/æ— èŠè€Œä¹°çš„ä¸œè¥¿ï¼Œä¾‹å¦‚ï¼šå¥¶èŒ¶ã€é›¶é£Ÿ" aria-label="æƒ…ç»ªæ€§æ¶ˆè´¹" rows="2"></textarea>
        </div>
        <div class="inline-row">
            <span class="inline-label">ä»Šæ—¥çš„â€œä»·å€¼æ¶ˆè´¹â€ï¼š</span>
            <textarea name="spendValue" placeholder="å¯¹æœªæ¥æˆ–é‡è¦éœ€æ±‚æœ‰å¸®åŠ©çš„æ¶ˆè´¹ï¼Œä¾‹å¦‚ï¼šé¢è¯•æ­£è£…ã€å¥½ä¹¦ã€åœ¨çº¿è¯¾ç¨‹" aria-label="ä»·å€¼æ¶ˆè´¹" rows="2"></textarea>
        </div>
    </div>

    <div class="section">
        <h3>IV. æ˜æ—¥å±•æœ› (å‡å°‘æ‹–å»¶)</h3>
        <h4>D. æ˜å¤©åªéœ€å®Œæˆçš„ 3 ä»¶å°äº‹</h4>
        <div class="note">ï¼ˆåªåˆ—å‡ºä¸‰ä»¶**å¿…é¡»å®Œæˆ**ä¸”**å…·ä½“å¯æ‰§è¡Œ**çš„å°ä»»åŠ¡ï¼Œé¿å…è¿‡åº¦å‹åŠ›ã€‚ï¼‰</div>
        <div class="inline-row"><span class="inline-label">1.</span><textarea name="todo1" rows="2" maxlength="120" placeholder="ä¾‹å¦‚ï¼šå‘é€ç®€å†åˆ°å…¬å¸A" aria-label="æ˜æ—¥ä»»åŠ¡1"></textarea></div>
        <div class="inline-row"><span class="inline-label">2.</span><textarea name="todo2" rows="2" maxlength="120" placeholder="ä¾‹å¦‚ï¼šç»™å¦ˆå¦ˆæ‰“ç”µè¯" aria-label="æ˜æ—¥ä»»åŠ¡2"></textarea></div>
        <div class="inline-row"><span class="inline-label">3.</span><textarea name="todo3" rows="2" maxlength="120" placeholder="ä¾‹å¦‚ï¼šæ´—å¹²å‡€æ˜¨å¤©å †ç§¯çš„è¡£æœ" aria-label="æ˜æ—¥ä»»åŠ¡3"></textarea></div>
        <div class="inline-hint">å»ºè®®å†™â€œåŠ¨è¯ + å¯¹è±¡ + æ—¶é—´/æ•°é‡â€ï¼Œä¾¿äºæ‰§è¡Œã€‚</div>
    </div>

    <div class="section">
        <h3>V. æ•°æ®æ€»è§ˆ (æœ€è¿‘ 7 å¤©è¯„åˆ†è¶‹åŠ¿ - æŸ±çŠ¶å›¾)</h3>
        <div class="note">å›¾è¡¨å±•ç¤ºæœ€è¿‘ 7 ä¸ª**æœ‰è®°å½•æ—¥æœŸ**çš„æƒ…ç»ªå’Œèƒ½é‡è¶‹åŠ¿ï¼ˆæ—¥æœŸä»å·¦åˆ°å³ï¼Œä»æ—§åˆ°æ–°ï¼‰ã€‚</div>
        <div id="chart-container">
            </div>
        <div class="note" style="margin-top: 15px;">æƒ…ç»ªè¯„åˆ†ï¼šè“è‰²æŸ± / èƒ½é‡è¯„åˆ†ï¼šç»¿è‰²æŸ±</div>
    </div>

    <div class="actions">
        <button class="btn" id="export-md" type="button">ğŸ“„ å¯¼å‡º Markdown</button>
        <button class="btn secondary" id="export-txt" type="button">ğŸ§¾ å¯¼å‡º TXT</button>
        <button class="btn secondary" id="print-page" type="button">ğŸ–¨ï¸ æ‰“å°/å¦å­˜ä¸ºPDF</button>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <script>
        // --- æ ¸å¿ƒå˜é‡ä¸åˆå§‹åŒ– ---
        const fields = Array.from(document.querySelectorAll('input, textarea, select')).filter(el => el.name && el.name !== 'date');
        const storageKey = 'daily-record-v2';
        const dateInput = document.getElementById('date');
        const dateStatus = document.getElementById('date-status');
        const nextDayBtn = document.getElementById('next-day'); // æ–°å¢ï¼šåä¸€å¤©æŒ‰é’®
        const clearDayBtn = document.getElementById('clear-day'); // æ–°å¢ï¼šæ¸…ç©ºæŒ‰é’®
        const toastEl = document.getElementById('toast');
        const lastSaveEl = document.getElementById('last-save');
        let lastDate = '';
        let toastTimer = null;
        let debounceTimer = null;

        // --- è¾…åŠ©å‡½æ•° ---
        const showToast = (msg) => {
            if (!toastEl) return;
            toastEl.textContent = msg;
            toastEl.classList.add('show');
            clearTimeout(toastTimer);
            toastTimer = setTimeout(() => toastEl.classList.remove('show'), 1400);
        };

        const readStore = () => {
            try {
                const cached = localStorage.getItem(storageKey);
                return cached ? JSON.parse(cached) : {};
            } catch (e) {
                console.warn('è¯»å–ç¼“å­˜å¤±è´¥', e);
                return {};
            }
        };

        const writeStore = (data) => {
            localStorage.setItem(storageKey, JSON.stringify(data));
        };

        const getCurrentDate = () => dateInput?.value || '';

        const clearFields = () => fields.forEach(el => {
            if (el.name === 'date') return;
            if (el.type === 'range') {
                el.value = '5';
                updateRangeValue(el.id);
            } else {
                el.value = '';
            }
        });

        const formatDate = (date) => {
            const d = new Date(date);
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        };

        const updateRangeValue = (id) => {
            const range = document.getElementById(id);
            const valueDisplay = document.getElementById(id.replace('-range', '-value'));
            if (range && valueDisplay) {
                valueDisplay.textContent = range.value;
            }
        };

        /**
         * æ£€æŸ¥æ—¥æœŸæ˜¯å¦æ˜¯æœªæ¥æ—¥æœŸï¼ˆå¤§äºä»Šå¤©ï¼‰ã€‚
         * @param {string} dateStr - æ ¼å¼ä¸º YYYY-MM-DD çš„æ—¥æœŸå­—ç¬¦ä¸²
         * @returns {boolean}
         */
        const isFutureDate = (dateStr) => {
            if (!dateStr) return false;
            const today = formatDate(new Date());
            return dateStr > today;
        };
        
        // --- æ ¸å¿ƒé€»è¾‘å‡½æ•° ---
        
        /**
         * æ£€æŸ¥ç›®æ ‡æ—¥æœŸæ˜¯å¦ä¸ºæœªæ¥ï¼Œå¹¶æ ¹æ®ç»“æœç¦ç”¨/å¯ç”¨è¾“å…¥å­—æ®µå’ŒæŒ‰é’®
         * @param {string} targetDate 
         */
        const checkFutureDateAndDisable = (targetDate) => {
            const isFuture = isFutureDate(targetDate);
            const isToday = targetDate === formatDate(new Date());
            
            // 1. ç¦ç”¨/å¯ç”¨æ‰€æœ‰è¾“å…¥å­—æ®µ
            fields.forEach(el => {
                el.disabled = isFuture;
            });

            // 2. ç¦ç”¨/å¯ç”¨å¯¼èˆªæŒ‰é’®å’Œæ¸…ç©ºæŒ‰é’®
            if (nextDayBtn) {
                // å¦‚æœæ˜¯ä»Šå¤©ï¼Œç¦ç”¨â€œåä¸€å¤©â€æŒ‰é’®
                nextDayBtn.disabled = isToday || isFuture;
            }
            if (clearDayBtn) {
                // æœªæ¥æ—¥æœŸä¹Ÿä¸èƒ½æ¸…ç©ºï¼ˆå› ä¸ºå®ƒæœ¬èº«å°±æ˜¯ç©ºçš„ï¼‰
                clearDayBtn.disabled = isFuture;
            }

            // 3. æ›´æ–°çŠ¶æ€æç¤º
            if (isFuture) {
                dateStatus.innerHTML = `<span style="color: #ef4444; font-weight: bold;">æœªæ¥æ—¥æœŸï¼š${targetDate}ã€‚æ— æ³•å¡«å†™ã€‚</span>`;
                // ç¡®ä¿æ¸…ç©ºå­—æ®µï¼Œæœªæ¥æ—¥æœŸæ— æ•°æ®
                clearFields();
                if (lastSaveEl) lastSaveEl.textContent = '';
                return true;
            }
            return false;
        };


        const loadData = (targetDate = getCurrentDate()) => {
            if (dateInput) dateInput.value = targetDate;
            
            // ä¼˜å…ˆæ£€æŸ¥å¹¶å¤„ç†æœªæ¥æ—¥æœŸ
            if (checkFutureDateAndDisable(targetDate)) {
                generateSummaryChart(readStore());
                return;
            }

            // å¦‚æœæ˜¯ä»Šå¤©æˆ–è¿‡å»ï¼ŒåŠ è½½æ•°æ®
            const store = readStore();
            clearFields();
            const data = store[targetDate] || {};
            fields.forEach(el => {
                if (data[el.name] !== undefined) {
                    el.value = data[el.name];
                    if (el.type === 'range') {
                        updateRangeValue(el.id);
                    }
                }
            });
            updateStatus(targetDate, !!store[targetDate], data.updatedAt);
            generateSummaryChart(store); 
        };

        const saveData = (targetDate = getCurrentDate(), silent = false) => {
            if (!targetDate || isFutureDate(targetDate)) return; // é˜»æ­¢ä¿å­˜æœªæ¥æ—¥æœŸ

            const store = readStore();
            const payload = {};
            fields.forEach(el => payload[el.name] = el.value);
            payload.date = targetDate;
            payload.updatedAt = Date.now();
            store[targetDate] = payload;
            writeStore(store);
            updateStatus(targetDate, true, payload.updatedAt);
            generateSummaryChart(store); 
            if (!silent) showToast('å·²è‡ªåŠ¨ä¿å­˜');
        };

        const handleDateChange = (newDate) => {
            if (!newDate) return;
            // ç¡®ä¿åœ¨åˆ‡æ¢æ—¥æœŸå‰ï¼Œå½“å‰æ—¥æœŸçš„æ•°æ®è¢«ä¿å­˜ (åŒæ­¥é™é»˜ä¿å­˜)
            saveData(lastDate || getCurrentDate(), true); 
            lastDate = newDate;
            loadData(newDate); 
        };

        const shiftDate = (delta) => {
            const base = dateInput.value ? new Date(dateInput.value) : new Date();
            base.setDate(base.getDate() + delta);
            const next = formatDate(base);
            handleDateChange(next);
        };

        const goToday = () => {
            handleDateChange(formatDate(new Date()));
        };

        const clearCurrent = () => {
            const current = getCurrentDate();
            if (!current || isFutureDate(current)) return; // é˜»æ­¢æ¸…ç©ºæœªæ¥æ—¥æœŸ
            
            const store = readStore();
            delete store[current];
            writeStore(store);
            clearFields();
            updateStatus(current, false, undefined);
            generateSummaryChart(store);
            showToast('å·²æ¸…ç©ºå½“å‰æ—¥æœŸ');
        };

        const updateStatus = (date, hasData, updatedAt) => {
            if (!dateStatus) return;
            dateStatus.textContent = hasData ? `å·²åŠ è½½ï¼š${date}` : `å½“å‰æ—¥æœŸæš‚æ— è®°å½•ï¼š${date}`;
            if (lastSaveEl) {
                if (updatedAt) {
                    const d = new Date(updatedAt);
                    const hh = String(d.getHours()).padStart(2, '0');
                    const mm = String(d.getMinutes()).padStart(2, '0');
                    lastSaveEl.textContent = `æœ€è¿‘ä¿å­˜ï¼š${hh}:${mm}`;
                } else {
                    lastSaveEl.textContent = '';
                }
            }
        };

        // --- æ•°æ®æ€»è§ˆå›¾è¡¨ç”Ÿæˆ (ä¿æŒä¸å˜ï¼Œå·²å«æ ‡æ³¨) ---
        const generateSummaryChart = (store) => {
            const chartContainer = document.getElementById('chart-container');
            if (!chartContainer) return;
            const maxBarHeight = 100;

            const allDates = Object.keys(store).filter(d => d);
            allDates.sort((a, b) => new Date(a) - new Date(b));
            const last7Days = allDates.slice(-7); 

            chartContainer.innerHTML = ''; 

            if (last7Days.length === 0) {
                chartContainer.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 30px 0; width: 100%;">æš‚æ— æœ€è¿‘çš„è®°å½•æ•°æ®ã€‚</div>';
                return;
            }

            const refLines = [
                { score: 10, label: '10' },
                { score: 5, label: '5' }
            ];
            
            refLines.forEach(ref => {
                const refLine = document.createElement('div');
                refLine.className = 'chart-ref-line';
                refLine.style.bottom = `${(ref.score / 10) * maxBarHeight}px`; 

                const refLabel = document.createElement('span');
                refLabel.className = 'ref-label';
                refLabel.textContent = ref.label;
                refLabel.style.bottom = `${(ref.score / 10) * maxBarHeight}px`;

                chartContainer.appendChild(refLine);
                chartContainer.appendChild(refLabel);
            });

            last7Days.forEach(dateStr => {
                const data = store[dateStr];
                const moodScore = Math.min(10, Math.max(0, parseInt(data.mood, 10) || 0));
                const energyScore = Math.min(10, Math.max(0, parseInt(data.energy, 10) || 0));
                const dateLabel = dateStr.substring(5); 

                const dayChart = document.createElement('div');
                dayChart.className = 'day-chart';

                const barGroup = document.createElement('div');
                barGroup.className = 'bar-group';

                const moodHeight = moodScore * 10; 
                const moodBar = document.createElement('div');
                moodBar.className = 'chart-bar chart-bar-mood';
                moodBar.style.height = `${moodHeight}px`;
                
                const energyHeight = energyScore * 10;
                const energyBar = document.createElement('div');
                energyBar.className = 'chart-bar chart-bar-energy';
                energyBar.style.height = `${energyHeight}px`;

                if (moodScore > 0) { 
                    const moodLabel = document.createElement('div');
                    moodLabel.className = 'score-label mood-label';
                    moodLabel.textContent = moodScore;
                    moodLabel.style.bottom = `${moodHeight}px`; 
                    barGroup.appendChild(moodLabel);
                }

                if (energyScore > 0) {
                    const energyLabel = document.createElement('div');
                    energyLabel.className = 'score-label energy-label';
                    energyLabel.textContent = energyScore;
                    energyLabel.style.bottom = `${energyHeight}px`;
                    barGroup.appendChild(energyLabel);
                }
                
                barGroup.appendChild(moodBar);
                barGroup.appendChild(energyBar);

                const label = document.createElement('div');
                label.className = 'chart-label';
                label.textContent = dateLabel;

                dayChart.appendChild(barGroup);
                dayChart.appendChild(label);
                chartContainer.appendChild(dayChart);
            });
        };
        
        // --- å¯¼å‡ºé€»è¾‘ (ä¿æŒä¸å˜) ---
        const downloadFile = (filename, content) => {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        };

        const toMarkdown = () => {
            const get = name => document.querySelector(`[name="${name}"]`)?.value || '';
            const dateStr = get('date') || 'æœªå¡«æ—¥æœŸ';
            const lines = [
                `# æ¯æ—¥æƒ…ç»ªä¸æŒæ§æ„Ÿè®°å½•`,
                `- æ—¥æœŸ: ${dateStr}`,
                `- æƒ…ç»ªè¯„åˆ†: ${get('mood')}`,
                `- èƒ½é‡è¯„åˆ†: ${get('energy')}`,
                `- ç¡çœ : ${get('sleepStart')} - ${get('sleepEnd')}`,
                ``,
                `## ä»Šæ—¥æœ€å¼€å¿ƒçš„ä¸‰ä»¶äº‹`,
                `1. ${get('happy1')}`,
                `2. ${get('happy2')}`,
                `3. ${get('happy3')}`,
                ``,
                `## æŒæ§æ„Ÿä¸è‡ªçˆ±è¡ŒåŠ¨`,
                `- å®Œæˆçš„è¡ŒåŠ¨: ${get('action')}`,
                `- è‡ªçˆ±è¡ŒåŠ¨: ${get('selflove')}`,
                ``,
                `## æƒ…ç»ª/å‹åŠ›è§¦å‘ç‚¹`,
                `${get('trigger')}`,
                ``,
                `## æ¶ˆè´¹é€Ÿè§ˆ`,
                `- æ€»é¢: ${get('spendTotal')}`,
                `- æƒ…ç»ªæ€§æ¶ˆè´¹: ${get('spendEmo')}`,
                `- ä»·å€¼æ¶ˆè´¹: ${get('spendValue')}`,
                ``,
                `## æ˜å¤©ä¸‰ä»¶å°äº‹`,
                `1. ${get('todo1')}`,
                `2. ${get('todo2')}`,
                `3. ${get('todo3')}`
            ];
            downloadFile(`daily-record-${dateStr}.md`, lines.join('\n'));
        };

        const toTXT = () => {
            const get = name => document.querySelector(`[name="${name}"]`)?.value || '';
            const dateStr = get('date') || 'æœªå¡«æ—¥æœŸ';
            const lines = [
                `æ—¥æœŸ: ${dateStr}`,
                `æƒ…ç»ªè¯„åˆ†: ${get('mood')}`,
                `èƒ½é‡è¯„åˆ†: ${get('energy')}`,
                `ç¡çœ : ${get('sleepStart')} - ${get('sleepEnd')}`,
                ``,
                `æœ€å¼€å¿ƒçš„ä¸‰ä»¶äº‹:`,
                `1) ${get('happy1')}`,
                `2) ${get('happy2')}`,
                `3) ${get('happy3')}`,
                ``,
                `å®Œæˆçš„å…·ä½“è¡ŒåŠ¨: ${get('action')}`,
                `è‡ªçˆ±è¡ŒåŠ¨: ${get('selflove')}`,
                ``,
                `æƒ…ç»ª/å‹åŠ›è§¦å‘ç‚¹:`,
                `${get('trigger')}`,
                ``,
                `æ¶ˆè´¹é€Ÿè§ˆ:`,
                `æ€»é¢: ${get('spendTotal')}`,
                `æƒ…ç»ªæ€§æ¶ˆè´¹: ${get('spendEmo')}`,
                `ä»·å€¼æ¶ˆè´¹: ${get('spendValue')}`,
                ``,
                `æ˜å¤©ä¸‰ä»¶å°äº‹:`,
                `1) ${get('todo1')}`,
                `2) ${get('todo2')}`,
                `3) ${get('todo3')}`
            ];
            downloadFile(`daily-record-${dateStr}.txt`, lines.join('\n'));
        };

        // --- åˆå§‹åŒ–å‡½æ•° ---
        const init = () => {
            const today = formatDate(new Date());
            if (!dateInput.value) {
                dateInput.value = today;
            }
            
            // è¿ç§»æ—§æ•°æ®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (!localStorage.getItem(storageKey) && localStorage.getItem('daily-record-v1')) {
                try {
                    const legacyData = JSON.parse(localStorage.getItem('daily-record-v1'));
                    writeStore({ [today]: { ...legacyData, date: today } });
                    localStorage.removeItem('daily-record-v1');
                } catch (e) {
                    console.warn('è¿ç§»æ—§æ•°æ®å¤±è´¥', e);
                }
            }

            // åˆå§‹åŒ–æ»‘å—æ•°å€¼æ˜¾ç¤º
            updateRangeValue('mood-range');
            updateRangeValue('energy-range');

            // åŠ è½½åˆå§‹æ•°æ®
            lastDate = getCurrentDate();
            loadData(lastDate);

            // ç›‘å¬äº‹ä»¶
            fields.forEach(el => el.addEventListener('input', (e) => {
                if (e.target.type === 'range') {
                    updateRangeValue(e.target.id);
                }
                
                // å¦‚æœæ˜¯æœªæ¥æ—¥æœŸï¼Œåˆ™ä¸å…è®¸ä¿å­˜
                if (isFutureDate(getCurrentDate())) return; 
                
                // ç«‹å³é™é»˜ä¿å­˜ï¼Œå¹¶è®¾ç½®é˜²æŠ–ä¿å­˜
                saveData(getCurrentDate(), true);
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => saveData(getCurrentDate(), false), 1200);
            }));
            
            ['change', 'input'].forEach(evt => {
                dateInput.addEventListener(evt, (e) => handleDateChange(e.target.value));
            });

            document.getElementById('prev-day').addEventListener('click', () => shiftDate(-1));
            document.getElementById('next-day').addEventListener('click', () => shiftDate(1));
            document.getElementById('goto-today').addEventListener('click', goToday);
            document.getElementById('clear-day').addEventListener('click', clearCurrent);
            document.getElementById('export-md').addEventListener('click', toMarkdown);
            document.getElementById('export-txt').addEventListener('click', toTXT);
            document.getElementById('print-page').addEventListener('click', () => window.print());

            // åˆå§‹ç”Ÿæˆæ•°æ®æ€»è§ˆ
            generateSummaryChart(readStore());
        };

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>