<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mood Control Log</title>
    <style>
        /* å®Œå…¨æ²¿ç”¨ä½ æä¾›çš„ CSSï¼ˆæ— æ”¹åŠ¨ï¼‰ */
        body { font-family: 'Arial', 'Microsoft YaHei', sans-serif; line-height: 1.6; max-width: 880px; margin: 25px auto; padding: 0 18px; background-color: #f0f2f5; }
        h2 {
            border-bottom: 2px dashed #b3cde0;
            padding-bottom: 8px;
            color: #1e3a8a;
            text-align: center;
            margin-bottom: 22px;
            font-family: 'Georgia', 'serif', 'Microsoft YaHei';
            letter-spacing: 1px;
        }
        h3 {
            color: #1f4b99;
            margin-top: 22px;
            border-left: 4px solid #a8c4fa;
            padding-left: 10px;
            font-weight: 600;
        }
        .section {
            margin-bottom: 26px;
            padding: 20px;
            border: 1px solid #e0e7ff;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
        }
        input[type="text"], input[type="date"], input[type="number"], select, input[type="time"] { width: 100%; max-width: 460px; padding: 7px 9px; border: 1px solid #c5ccd6; border-radius: 6px; box-sizing: border-box; transition: border-color 0.3s, box-shadow 0.2s; background: #fff; font-family: inherit; white-space: normal; word-break: break-word; line-height: 1.3; min-height: 28px; }
        input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, input[type="time"]:focus, textarea:focus {
            border-color: #7b9fe8;
            outline: none;
            box-shadow: 0 0 0 3px rgba(123, 159, 232, 0.2);
        }
        input[type="date"], input[type="time"] { max-width: 220px; padding: 8px; }
        textarea { width: 100%; min-height: 52px; padding: 8px 9px; border: 1px solid #c5ccd6; border-radius: 6px; box-sizing: border-box; resize: vertical; font-family: inherit; white-space: pre-wrap; word-break: break-word; line-height: 1.35; }
        input[readonly], textarea[readonly], input[type="range"][readonly] {
            background-color: #f0f0f0 !important;
            color: #6b7280;
            cursor: not-allowed;
            opacity: 0.8;
        }
        input[type="range"][readonly]::-webkit-slider-thumb {
            cursor: not-allowed;
            background: #9ca3af !important;
        }
        input[type="range"][readonly]::-moz-range-thumb {
            cursor: not-allowed;
            background: #9ca3af !important;
        }
        input[disabled], textarea[disabled], input[type="range"][disabled] {
            cursor: not-allowed;
            background-color: #f7f7f7 !important;
            border-color: #e5e7eb !important;
            color: #9ca3af;
        }
        input[type="range"][disabled]::-webkit-slider-thumb {
            background: #aeb5c2 !important;
            box-shadow: none !important;
        }
        ::placeholder { font-family: inherit; color: #9ca3af; opacity: 1; white-space: normal; word-break: break-word; line-height: 1.3; }
        .note {
            font-size: 0.9em;
            color: #7889a7;
            margin-top: 5px;
            display: block;
        }
        .mindset {
            background-color: #f5f8ff;
            border-left: 5px solid #a8c4fa;
            padding: 18px;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .mindset p { margin: 5px 0; color: #1e3a8a; font-size: 0.9em; }
        .actions { display: flex; flex-wrap: wrap; gap: 10px; margin: 14px 0 6px; }
        .date-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            margin-bottom: 4px;
        }
        .date-status { font-size: 0.9em; color: #374151; }
        .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; background-color: #2563eb; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95em; box-shadow: 0 3px 8px rgba(37, 99, 235, 0.25); transition: transform 0.1s ease, background-color 0.2s; }
        .btn:hover { background-color: #1d4ed8; }
        .btn:active { transform: translateY(1px); }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; box-shadow: none; transform: none; }
        .btn.secondary { background-color: #6b7280; box-shadow: 0 3px 8px rgba(107, 114, 128, 0.25); }
        .btn.secondary:hover { background-color: #4b5563; }
        .last-save-display {
            font-size: 0.9em;
            color: #4b5563;
            margin: 4px 0 8px 0;
        }
        .last-save-time {
            font-weight: 600;
            color: #1e3a8a;
        }
        .inline-hint {
            font-size: 0.9em;
            color: #4b5563;
            margin-top: 0;
        }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; margin-top: 10px; }
        .metric { border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; background: #f9fafb; box-shadow: 0 2px 4px rgba(0,0,0,0.04); }
        .metric-label { display: flex; align-items: center; gap: 8px; font-weight: 700; color: #1e3a8a; }
        .metric-body { font-size: 0.95em; color: #374151; margin: 6px 0 10px; }
        .inline-row {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin: 8px 0;
        }
        .inline-label {
            white-space: nowrap;
            font-weight: 600;
            color: #1e3a8a;
            padding-top: 8px;
        }
        .inline-row textarea {
            flex: 1;
            min-width: 0;
        }
        .btn.ghost { background: #eef2ff; color: #1e3a8a; box-shadow: none; }
        .btn.ghost:hover { background: #dbeafe; }
        .btn.ghost:disabled { background-color: #e5e7eb; color: #9ca3af; }
        .toast { position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%); background: rgba(31,41,55,0.9); color: #fff; padding: 10px 14px; border-radius: 8px; box-shadow: 0 8px 20px rgba(0,0,0,0.18); font-size: 0.95em; opacity: 0; pointer-events: none; transition: opacity 0.2s ease; z-index: 9999; }
        .toast.show { opacity: 1; }
        h4 { margin: 10px 0 6px; }
        .note { margin-top: 2px; }
        .rating-labels { display: flex; justify-content: space-between; font-size: 0.9em; color: #6b7280; padding: 0 2px; margin-top: 2px; font-weight: bold; }
        .rating-value { font-weight: 700; color: #1e3a8a; text-align: center; margin-top: 4px; font-size: 1.1em; }
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #e0e7ff; border-radius: 5px; transition: opacity .2s; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #4f8ef5; cursor: pointer; border: 2px solid #ffffff; box-shadow: 0 0 4px rgba(0, 0, 0, 0.15); }
        input[type="range"]::-moz-range-thumb { width: 18px; height: 18px; border-radius: 50%; background: #4f8ef5; cursor: pointer; border: 2px solid #ffffff; box-shadow: 0 0 4px rgba(0, 0, 0, 0.15); }
        #chart-container {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 140px;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 2px solid #e5e7eb;
            position: relative;
            padding-left: 20px;
            box-sizing: content-box;
        }
        .chart-ref-line { position: absolute; left: 20px; width: calc(100% - 20px); border-top: 1px dotted #d1d5db; }
        .ref-label { position: absolute; left: 0px; font-size: 0.75em; color: #6b7280; line-height: 1; transform: translateY(-50%); font-weight: 500; }
        .day-chart { flex: 1 1 0; display: flex; flex-direction: column; align-items: center; height: 100%; min-width: 30px; }
        .bar-group { display: flex; align-items: flex-end; height: 100px; width: 100%; justify-content: center; gap: 2px; position: relative; }
        .chart-bar { width: 45%; transition: height 0.3s ease; border-radius: 3px 3px 0 0; opacity: 0.9; min-height: 1px; }
        .chart-bar-mood { background-color: #4f8ef5; }
        .chart-bar-energy { background-color: #10b981; }
        .chart-label { font-size: 0.8em; color: #6b7280; margin-top: 5px; text-align: center; }
        .score-label { position: absolute; text-align: center; font-size: 0.75em; font-weight: bold; transition: all 0.3s ease; transform: translateY(-100%); line-height: 1; }
        .mood-label { left: 5%; width: 45%; color: #1e3a8a; }
        .energy-label { left: 50%; width: 45%; color: #065f46; }
        .chart-legend { display: flex; justify-content: center; gap: 20px; margin-top: 15px; font-size: 0.9em; color: #4b5563; }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-color-box { width: 16px; height: 10px; border-radius: 3px; }
        .legend-mood { background-color: #4f8ef5; }
        .legend-energy { background-color: #10b981; }
        #calendar-container { padding: 15px; background-color: #fcfdff; border-radius: 10px; margin-top: 15px; box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.05); }
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; gap: 5px; }
        .day-name { font-weight: 700; color: #4b5563; padding: 8px 0; font-size: 0.9em; }
        .calendar-day { padding: 8px 0; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background-color 0.2s, transform 0.1s; font-size: 0.95em; min-height: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; color: #374151; }
        .calendar-day:hover:not(.empty-day) { background-color: #e0e7ff; }
        .calendar-day.today { border: 2px solid #2563eb; background-color: #dbeafe; font-weight: 700; }
        .calendar-day.selected-day { background-color: #ffe0b2; border: 2px solid #ff9800; color: #333; font-weight: 700; transform: scale(1.05); }
        .calendar-day.today.selected-day { border: 2px solid #ff9800; background-color: #fff3e0; }
        .calendar-day.recorded { background-color: #90ee90; color: #1e3a8a; font-weight: 700; box-shadow: 0 2px 4px rgba(144, 238, 144, 0.5); border: 1px solid #7cb97c; }
        .calendar-day.recorded:hover { background-color: #7ccd7c; }
        .calendar-day.empty-day { color: #aeb5c2; cursor: default; background-color: transparent; }
        .recorded-mark { position: absolute; bottom: 2px; font-size: 0.7em; color: #1e3a8a; line-height: 1; }
        @media (max-width: 640px) {
            body { font-size: 15px; padding: 0 12px; }
            h2 { font-size: 1.25em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 16px; }
            h3 { font-size: 1.1em; }
            .metric-body { font-size: 0.9em; }
            .btn, input, textarea { font-size: 0.9em; }
            .metrics { grid-template-columns: 1fr; }
            #chart-container { padding-left: 15px; height: 120px; }
            .chart-ref-line { left: 15px; width: calc(100% - 15px); }
            .ref-label { left: 0px; }
            .score-label { font-size: 0.7em; }
            #calendar-grid { gap: 3px; }
            .calendar-day { font-size: 0.9em; padding: 6px 0; }
            .day-name { font-size: 0.8em; }
        }
    </style>
</head>
<body>
    <h2>ğŸ’« æ¯æ—¥çŠ¶æ€è½»è®°å½•ï¼šé‡å»ºè‡ªæˆ‘è¿æ¥ ğŸ’–</h2>
    <div class="section mindset">
        <h3>ğŸ”‘ åšæŒçš„è¯€çªï¼šè¶Šç®€å•è¶Šå¥½</h3>
        <p>1. å›ºå®šæ—¶é—´ï¼šå»ºè®®åœ¨ç¡å‰æˆ–æ—©æ™¨ï¼Œé€‰æ‹©ä¸€ä¸ªå›ºå®šæ—¶é—´æ¥åšè®°å½•ï¼Œå½¢æˆä¹ æƒ¯</p>
        <p>2. æç®€åŸåˆ™ï¼šå¦‚æœä»Šå¤©ä½ æ„Ÿè§‰ç‰¹åˆ«ç´¯ï¼Œåªè®°å½• æƒ…ç»ªå’Œèƒ½é‡è¯„åˆ† æˆ– æœ€å¼€å¿ƒçš„äº‹ å³å¯ã€‚ä»»ä½•ä¸€ç‚¹è®°å½•éƒ½æ¯”å®Œå…¨æ”¾å¼ƒè¦å¥½</p>
        <p>3. ä¸å¸¦è¯„åˆ¤ï¼šè®°å½•æ—¶ä¸è¦è¯„åˆ¤è‡ªå·±â€œä»Šå¤©åˆæ²¡å®Œæˆä»»åŠ¡â€ã€â€œä»Šå¤©çš„æ¶ˆè´¹å¤ªé«˜äº†â€ã€‚è®°å½•çš„ç›®çš„æ˜¯å®¢è§‚äº†è§£çŠ¶æ€ï¼Œè€Œä¸æ˜¯æŒ‡è´£è‡ªå·±</p>
    </div>
    <!-- æ–°å¢ï¼šå¤‡ä»½æç¤º -->
    <div class="section" style="border: 2px solid #ffcc00; background-color: #fffbeb; border-radius: 12px;">
        <p style="color: #d97706; font-weight: 600; margin: 0; padding: 10px 0;">
            âš ï¸ <strong>é‡è¦æç¤º</strong>ï¼šæ‰€æœ‰æ•°æ®ä»…ä¿å­˜åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰ã€‚
        </p>
        <p style="color: #92400e; margin: 8px 0 0 0; font-size: 0.95em;">
            è‹¥æ‚¨æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ã€ä½¿ç”¨æ— ç—•æ¨¡å¼ã€æ›´æ¢è®¾å¤‡æˆ–é‡è£…ç³»ç»Ÿï¼Œ<strong>è®°å½•å°†æ°¸ä¹…ä¸¢å¤±</strong>ã€‚
            å¼ºçƒˆå»ºè®®æ‚¨å®šæœŸå¯¼å‡º CSV/JSON å¤‡ä»½ã€‚
        </p>
        <p id="storage-usage" style="color: #7a2e00; margin: 8px 0 0 0; font-size: 0.9em;">å½“å‰å·²ç”¨å­˜å‚¨çº¦ï¼š-- KB</p>
    </div>
    <div class="section">
        <h3>ğŸ“… åŸºæœ¬ä¿¡æ¯</h3>
        <div class="date-row">
            <strong>è®°å½•æ—¥æœŸï¼š</strong>
            <input id="date" name="date" type="date" aria-label="è®°å½•æ—¥æœŸ">
            <button class="btn secondary" id="prev-day" type="button">â† å‰ä¸€å¤©</button>
            <button class="btn secondary" id="next-day" type="button">åä¸€å¤© â†’</button>
            <button class="btn ghost" id="goto-today" type="button">å›åˆ°ä»Šå¤©</button>
            <button class="btn ghost" id="toggle-edit" type="button">ğŸ”“ ä¿®æ”¹å†å²è®°å½•</button>
            <button class="btn ghost" id="clear-day" type="button">æ¸…ç©ºå½“å‰</button>
            <span class="date-status" id="date-status"></span>
        </div>
        <p class="last-save-display"><span id="last-save" class="last-save-time"></span></p>
        <div class="inline-hint">é»˜è®¤å¡«å…¥ä»Šå¤©ã€‚åˆ‡æ¢æ—¥æœŸå³å¯æŸ¥çœ‹/å¡«å†™å†å²è®°å½•ã€‚ç³»ç»Ÿç¦æ­¢å¡«å†™æœªæ¥æ—¥æœŸï¼Œå‡è½»æ‚¨çš„â€œé¢„è®¾â€å‹åŠ›ã€‚</div>
    </div>
    <div class="section">
        <h3>è®°å½•æ¦‚è§ˆ</h3>
        <div id="calendar-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <button class="btn ghost" id="prev-month-btn" type="button">â† ä¸Šä¸ªæœˆ</button>
                <h4 id="current-month-year" style="margin: 0; color: #1e3a8a;"></h4>
                <button class="btn ghost" id="next-month-btn" type="button">ä¸‹ä¸ªæœˆ â†’</button>
            </div>
            <div id="calendar-grid">
                <div class="day-name">æ—¥</div>
                <div class="day-name">ä¸€</div>
                <div class="day-name">äºŒ</div>
                <div class="day-name">ä¸‰</div>
                <div class="day-name">å››</div>
                <div class="day-name">äº”</div>
                <div class="day-name">å…­</div>
            </div>
        </div>
        <div class="note">âœ… æ ‡è®°çš„æ—¥æœŸè¡¨ç¤ºæ‚¨å·²å¡«å†™è®°å½•ã€‚ç‚¹å‡»æ—¥æœŸå¯å¿«é€Ÿè·³è½¬ã€‚</div>
    </div>
    <div class="section">
        <h3>I. å½“ä¸‹æ„Ÿå—çš„æ•æ‰</h3>
        <div class="metrics">
            <div class="metric">
                <div class="metric-label">æƒ…ç»ªè¯„åˆ† (1-10)</div>
                <div class="metric-body">æ­¤åˆ»çš„æ€»ä½“æ„Ÿå—æ˜¯ä»€ä¹ˆï¼Ÿ1=éå¸¸ä½è½ï¼Œ5=å¹³é™/ä¸­æ€§ï¼Œ10=éå¸¸å¿«ä¹</div>
                <div class="rating-value" id="mood-value">5</div>
                <input type="range" min="1" max="10" step="1" value="5" class="metric-score" name="mood" id="mood-range" aria-label="æƒ…ç»ªè¯„åˆ†">
                <div class="rating-labels"><span>1</span><span>10</span></div>
            </div>
            <div class="metric">
                <div class="metric-label">èƒ½é‡è¯„åˆ† (1-10)</div>
                <div class="metric-body">æ­¤åˆ»èº«ä½“æ„Ÿå—åˆ°çš„ç²¾åŠ›å¦‚ä½•ï¼Ÿ1=ç–²æƒ«æ— åŠ›ï¼Œ5=æ­£å¸¸/å¹³ç¨³ï¼Œ10=å……æ»¡æ´»åŠ›</div>
                <div class="rating-value" id="energy-value">5</div>
                <input type="range" min="1" max="10" step="1" value="5" class="metric-score" name="energy" id="energy-range" aria-label="èƒ½é‡è¯„åˆ†">
                <div class="rating-labels"><span>1</span><span>10</span></div>
            </div>
            <div class="metric">
                <div class="metric-label">ç¡çœ è®°å½•</div>
                <div class="metric-body">
                    <span style="color:#d97706;font-weight:600;">â— å¿…å¡«é¡¹</span>ï¼Œå³ä½¿æ˜¯å¤±çœ åˆ°å‡Œæ™¨4ç‚¹ä¹Ÿè¦å¦‚å®è®°å½•
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
                    <span>å…¥ç¡æ—¶é—´ï¼š</span>
                    <input type="time" name="sleepStart" aria-label="å…¥ç¡æ—¶é—´">
                    <span>é†’æ¥æ—¶é—´ï¼š</span>
                    <input type="time" name="sleepEnd" aria-label="é†’æ¥æ—¶é—´">
                </div>
            </div>
        </div>
    </div>
    <div class="section">
        <h3>II. å€¼å¾—è¢«çœ‹è§çš„ç¾å¥½ä¸å°èƒœåˆ©</h3>
        <h4>ä»Šæ—¥æœ€å¼€å¿ƒçš„ä¸‰ä»¶äº‹</h4>
        <div class="note">ä¸ä¸€å®šè¦æ˜¯â€œå¤§äº‹â€ï¼Œä¹Ÿå¯ä»¥æ˜¯è®©ä½ æ„Ÿåˆ°è‡ªå·±è¿˜æ´»ç€çš„ä¸€ä¸ªç¬é—´ï¼Œè¶Šå…·ä½“è¶Šå¥½ã€‚</div>
        <div class="inline-row">
          <span class="inline-label">1.</span>
          <div style="flex:1; position:relative;">
            <textarea name="happy1" rows="2" placeholder="ä¾‹å¦‚ï¼šé˜³å…‰æ´’åœ¨èº«ä¸Šå¾ˆèˆ’æœ..." aria-label="æœ€å¼€å¿ƒçš„äº‹1"></textarea>
            <div class="char-count" style="font-size:0.85em; color:#6b7280; margin-top:2px; text-align:right;" data-target="happy1">0 è¡Œ</div>
          </div>
        </div>
        <div class="inline-row">
          <span class="inline-label">2.</span>
          <div style="flex:1; position:relative;">
            <textarea name="happy2" rows="2" placeholder="ä¾‹å¦‚ï¼šå–åˆ°ä¸€æ¯å¥½å’–å•¡..." aria-label="æœ€å¼€å¿ƒçš„äº‹2"></textarea>
            <div class="char-count" style="font-size:0.85em; color:#6b7280; margin-top:2px; text-align:right;" data-target="happy2">0 è¡Œ</div>
          </div>
        </div>
        <div class="inline-row">
          <span class="inline-label">3.</span>
          <div style="flex:1; position:relative;">
            <textarea name="happy3" rows="2" placeholder="ä¾‹å¦‚ï¼šçƒ­æ°´æ‰‘åœ¨è„¸ä¸Šçš„æ¸©åº¦..." aria-label="æœ€å¼€å¿ƒçš„äº‹3"></textarea>
            <div class="char-count" style="font-size:0.85em; color:#6b7280; margin-top:2px; text-align:right;" data-target="happy3">0 è¡Œ</div>
          </div>
        </div>
        <h4>ä»Šæ—¥çš„æŒæ§æ„Ÿ</h4>
        <div class="note">è®°å½•ä¸€ä»¶æ‚¨ä¸»åŠ¨å®Œæˆçš„äº‹æƒ…ï¼Œå¢å¼ºå¯¹è‡ªæˆ‘è¡ŒåŠ¨çš„è‚¯å®š</div>
        <textarea name="action" rows="2" placeholder="ä¾‹å¦‚ï¼šæˆ‘æŒ‰æ—¶åƒäº†åˆé¥­ã€æˆ‘åšæŒè¿åŠ¨äº†10åˆ†é’Ÿã€æˆ‘ä¸ºé¢è¯•å‡†å¤‡äº†1ä¸ªå°æ—¶ã€æˆ‘æŠŠæ˜¨å¤©çš„æ—§é‚®ä»¶æ¸…ç†äº†" aria-label="ä»Šæ—¥çš„æŒæ§æ„Ÿ"></textarea>
        <h4>ä»Šæ—¥çš„è‡ªçˆ±è¡ŒåŠ¨</h4>
        <div class="note">è®°å½•ä¸€ä¸ªæ‚¨ä¸ºè‡ªå·±èº«ä½“æˆ–å¿ƒç†å¥åº·åšå‡ºçš„è¡ŒåŠ¨ï¼Œå…³æ³¨è‡ªæˆ‘éœ€æ±‚ï¼Œæ‰“ç ´æ‹–å»¶å¯¼è‡´çš„è‡ªæˆ‘æƒ©ç½š</div>
        <textarea name="selflove" rows="2" placeholder="ä¾‹å¦‚ï¼šæˆ‘æ²¡æœ‰ç†¬å¤œï¼Œåœ¨11ç‚¹å‰èººä¸‹äº†ã€æˆ‘ç»™çš®è‚¤æ¶‚äº†ä¹³æ¶²ã€æˆ‘å¬äº†30åˆ†é’Ÿçš„æ”¾æ¾éŸ³ä¹" aria-label="ä»Šæ—¥çš„è‡ªçˆ±è¡ŒåŠ¨"></textarea>
    </div>
    <div class="section">
        <h3>III. ä»…ä»…æ˜¯è§‚å¯Ÿä¸äº†è§£</h3>
        <h4>æƒ…ç»ªè§¦å‘ç‚¹</h4>
        <div class="note">å¦‚æœä»Šå¤©æƒ…ç»ªåˆ†ä½äº 5 åˆ†ï¼Œè®°å½•å‘ç”Ÿäº†ä¸€ä»¶ä»€ä¹ˆäº‹ï¼Œæˆ–è„‘æµ·é‡Œçªç„¶å†’å‡ºäº†ä»€ä¹ˆæƒ³æ³•ï¼Œå¯¼è‡´æƒ…ç»ªä¸‹æ»‘ï¼Œæ‰¾å‡ºå¼•èµ·ä½è½æˆ–ç„¦è™‘çš„å…·ä½“äº‹ä»¶</div>
        <textarea name="trigger" placeholder="ä¾‹å¦‚ï¼šé¢è¯•å®˜çš„ä¸€ä¸ªé—®é¢˜è®©æˆ‘è§‰å¾—è‡ªå·±èƒ½åŠ›å¾ˆå·®ï¼Œçªç„¶å¼€å§‹å¦å®šè‡ªå·±ã€‚" aria-label="æƒ…ç»ªå‹åŠ›è§¦å‘ç‚¹"></textarea>
        <h4>è‡ªæ•‘è¡Œä¸º</h4>
        <div class="note">æ‚¨åšäº†ä»€ä¹ˆæ¥é˜»æ­¢æƒ…ç»ªè¿›ä¸€æ­¥æ¶åŒ–ï¼Ÿè¯·è®°å½•è‡ªå·±å¦‚ä½•ä»ä½è½ä¸­è‡ªæ•‘</div>
        <textarea name="rescue" rows="2" placeholder="ä¾‹å¦‚ï¼šæˆ‘å‘æœ‹å‹å€¾è¯‰äº†ã€æˆ‘åœæ­¢äº†æ€è€ƒï¼Œå»çœ‹äº†ä¸€éƒ¨ç”µå½±ã€æˆ‘å‡ºå»æ•£æ­¥äº†10åˆ†é’Ÿã€‚" aria-label="è‡ªæ•‘è¡Œä¸º"></textarea>
        <h4>ä»Šæ—¥æ¶ˆè´¹é€Ÿè§ˆ</h4>
        <p><strong>æ¶ˆè´¹æ€»é¢ï¼š</strong> Â¥ <input name="spendTotal" type="number" step="0.01" min="0" placeholder="ä¾‹å¦‚ï¼š128.5" aria-label="ä»Šæ—¥æ¶ˆè´¹æ€»é¢"></p>
        <h4>æƒ…ç»ªæ€§æ¶ˆè´¹</h4>
        <div class="note">è®°å½•æ˜¯å¦å› ç„¦è™‘/æ— èŠ/ä½è½è€Œä¹°äº†ä¸œè¥¿ï¼Œè§‰å¯Ÿè‡ªå·±æ˜¯å¦ç”¨æ¶ˆè´¹æ¥åº”å¯¹æƒ…ç»ª</div>
        <textarea name="spendEmo" rows="2" placeholder="ä¹°çš„æ˜¯ä»€ä¹ˆï¼Œä»¥åŠè´­ä¹°æ—¶çš„æƒ…ç»ª" aria-label="æƒ…ç»ªæ€§æ¶ˆè´¹"></textarea>
        <h4>æŠ•èµ„æ€§æ¶ˆè´¹</h4>
        <div class="note">è®°å½•ä¸€ç¬”æ‚¨è§‰å¾—â€œå¾ˆå€¼â€æˆ–â€œå¯¹æœªæ¥æœ‰å¸®åŠ©â€çš„æ¶ˆè´¹ï¼ŒåŒºåˆ†æŠ•èµ„æ¶ˆè´¹ä¸æƒ…ç»ªæ¶ˆè´¹</div>
        <textarea name="spendValue" rows="2" placeholder="ä¾‹å¦‚ï¼šè´­ä¹°äº†é¢è¯•æ­£è£…ã€è´­ä¹°äº†ä¸€æœ¬å¥½ä¹¦ã€ä»˜äº†å¥èº«å¡è´¹ç”¨" aria-label="æŠ•èµ„æ€§æ¶ˆè´¹"></textarea>
    </div>
    <div class="section">
        <h3>IV. ç»™æ˜å¤©çš„è‡ªå·±</h3>
        <h4>æ˜å¤©åªéœ€å®Œæˆçš„ 3 ä»¶å°äº‹</h4>
        <div class="note">åªåˆ—å‡ºä¸‰ä»¶å¿…é¡»å®Œæˆä¸”å…·ä½“å¯æ‰§è¡Œçš„å°ä»»åŠ¡ï¼Œå°†æ˜å¤©çš„å‹åŠ›åˆ†è§£ï¼Œé¿å…è¿‡åº¦æ‹–å»¶ã€‚</div>
        <div class="inline-row">
          <span class="inline-label">1.</span>
          <div style="flex:1; position:relative;">
            <textarea name="todo1" rows="2" maxlength="120" placeholder="ä¾‹å¦‚ï¼šå‘é€ç®€å†åˆ°å…¬å¸A" aria-label="æ˜æ—¥ä»»åŠ¡1"></textarea>
            <div class="char-count" style="font-size:0.85em; color:#6b7280; margin-top:2px; text-align:right;" data-target="todo1">0 / 120</div>
          </div>
        </div>
        <div class="inline-row">
          <span class="inline-label">2.</span>
          <div style="flex:1; position:relative;">
            <textarea name="todo2" rows="2" maxlength="120" placeholder="ä¾‹å¦‚ï¼šç»™å¦ˆå¦ˆæ‰“ç”µè¯" aria-label="æ˜æ—¥ä»»åŠ¡2"></textarea>
            <div class="char-count" style="font-size:0.85em; color:#6b7280; margin-top:2px; text-align:right;" data-target="todo2">0 / 120</div>
          </div>
        </div>
        <div class="inline-row">
          <span class="inline-label">3.</span>
          <div style="flex:1; position:relative;">
            <textarea name="todo3" rows="2" maxlength="120" placeholder="ä¾‹å¦‚ï¼šæ´—å¹²å‡€æ˜¨å¤©å †ç§¯çš„è¡£æœ" aria-label="æ˜æ—¥ä»»åŠ¡3"></textarea>
            <div class="char-count" style="font-size:0.85em; color:#6b7280; margin-top:2px; text-align:right;" data-target="todo3">0 / 120</div>
          </div>
        </div>
        <div class="inline-hint">ä¸ºäº†è®©è¡ŒåŠ¨æ›´å®¹æ˜“è¢«å®Œæˆï¼Œå»ºè®®ä½¿ç”¨â€œåŠ¨è¯ + å¯¹è±¡ + æ—¶é—´/æ•°é‡â€çš„æè¿°æ–¹å¼ã€‚</div>
    </div>
    <div class="section">
        <h3>V. æœ€è¿‘ 7 å¤©å¿ƒæƒ…</h3>
        <div class="note">æœ€è¿‘7ä¸ªæœ‰è®°å½•æ—¥æœŸçš„æƒ…ç»ªå’Œèƒ½é‡è¶‹åŠ¿</div>
        <div id="chart-container"></div>
        <div class="chart-legend">
            <div class="legend-item"><span class="legend-color-box legend-mood"></span><span>æƒ…ç»ªè¯„åˆ† (è“è‰²)</span></div>
            <div class="legend-item"><span class="legend-color-box legend-energy"></span><span>èƒ½é‡è¯„åˆ† (ç»¿è‰²)</span></div>
        </div>
    </div>
    <div class="actions">
        <button class="btn" id="export-all-md" type="button">ğŸ“„ å¯¼å‡ºå…¨éƒ¨ Markdown</button>
        <button class="btn secondary" id="export-all-csv" type="button">ğŸ“Š å¯¼å‡ºå…¨éƒ¨ CSV</button>
        <button class="btn" id="export-all-json" type="button">ğŸ“¦ å¯¼å‡ºå…¨éƒ¨ JSON</button>
        <button class="btn" id="export-single-md" type="button">ğŸ“„ å¯¼å‡ºå½“å¤© Markdown</button>
        <button class="btn secondary" id="export-single-csv" type="button">ğŸ“Š å¯¼å‡ºå½“å¤© CSV</button>
        <button class="btn" id="export-single-json" type="button">ğŸ“¦ å¯¼å‡ºå½“å¤© JSON</button>
        <label class="btn ghost" style="cursor:pointer;">
            ğŸ“¥ å¯¼å…¥ CSV/JSON
            <input type="file" id="import-file" accept=".csv,.json" style="display:none;">
        </label>
        <button class="btn secondary" id="print-page" type="button">ğŸ–¨ï¸ æ‰“å°/å¦å­˜ä¸ºPDF</button>
    </div>
    <div id="toast" class="toast" role="status" aria-live="polite"></div>
    <script>
        /*
         * Mood Control Log - v3 ç»´æŠ¤è¯´æ˜
         * ä½œè€…ï¼šå°ç™½ï¼ˆå…¬ç›Šåˆ†å‘ï¼‰
         * ç‰¹æ€§ï¼šçº¯ç¦»çº¿ | æ— è¿½è¸ª | æ•°æ®æœ¬åœ°éš”ç¦»
         * å­˜å‚¨ç»“æ„ï¼š{ _meta: { version, lastBackupReminder }, "YYYY-MM-DD": { ... } }
         *
         * ç»´æŠ¤æŒ‡å—ï¼š
         * 1. æ–°å¢å­—æ®µï¼šè¯·åœ¨ FIELDS_CONFIG ä¸­æ³¨å†Œ
         * 2. å­—æ®µç±»å‹ï¼š'text' | 'time' | 'number' | 'range'
         * 3. å¿…å¡«é¡¹ï¼šè®¾ required: trueï¼ˆç›®å‰ä»… sleepStart/sleepEndï¼‰
         * 4. æ‰€æœ‰é€»è¾‘ï¼ˆæœ‰æ•ˆæ€§åˆ¤æ–­/å¯¼å‡º/å¯¼å…¥ï¼‰å‡è‡ªåŠ¨é€‚é…æ­¤é…ç½®
         */
        const FIELDS_CONFIG = {
            mood: { type: 'range', default: '5', required: false },
            energy: { type: 'range', default: '5', required: false },
            sleepStart: { type: 'time', required: true },
            sleepEnd: { type: 'time', required: true },
            happy1: { type: 'text', required: false },
            happy2: { type: 'text', required: false },
            happy3: { type: 'text', required: false },
            action: { type: 'text', required: false },
            selflove: { type: 'text', required: false },
            trigger: { type: 'text', required: false },
            rescue: { type: 'text', required: false },
            spendTotal: { type: 'number', required: false },
            spendEmo: { type: 'text', required: false },
            spendValue: { type: 'text', required: false },
            todo1: { type: 'text', required: false },
            todo2: { type: 'text', required: false },
            todo3: { type: 'text', required: false }
        };

        // ========== æ ¸å¿ƒå˜é‡ ==========
        const fields = Array.from(document.querySelectorAll('input:not([type="date"]), textarea'));
        const rangeInputs = document.querySelectorAll('input[type="range"]');
        const storageKey = 'daily-record-v3'; // å‡çº§åˆ° v3
        const dateInput = document.getElementById('date');
        const dateStatus = document.getElementById('date-status');
        const nextDayBtn = document.getElementById('next-day');
        const clearDayBtn = document.getElementById('clear-day');
        const toggleEditBtn = document.getElementById('toggle-edit');
        const toastEl = document.getElementById('toast');
        const lastSaveEl = document.getElementById('last-save');
        const storageUsageEl = document.getElementById('storage-usage');
        let lastDate = '';
        let toastTimer = null;
        let debounceTimer = null;
        let editMode = false;
        let currentMonth = new Date(); // âœ… æ­£ç¡®å£°æ˜
        // ========== æ»‘å—è§¦æ‘¸çŠ¶æ€ ==========
        let moodTouched = false;
        let energyTouched = false;

        // ========== å·¥å…·å‡½æ•° ==========
        const showToast = (msg) => {
            toastEl.textContent = msg;
            toastEl.classList.add('show');
            clearTimeout(toastTimer);
            toastTimer = setTimeout(() => toastEl.classList.remove('show'), 1600);
        };

        const formatDate = (date) => {
            const d = new Date(date);
            const offset = d.getTimezoneOffset() * 60000;
            const localDate = new Date(d.getTime() - offset);
            return `${localDate.getFullYear()}-${String(localDate.getMonth() + 1).padStart(2, '0')}-${String(localDate.getDate()).padStart(2, '0')}`;
        };

        const isFutureDate = (dateStr) => dateStr > formatDate(new Date());

        const getStorageUsage = (data) => {
            try {
                return (new Blob([JSON.stringify(data)]).size / 1024).toFixed(1);
            } catch {
                return '--';
            }
        };

        const getFieldLabel = (fieldName) => {
            const map = {
                'sleepStart': 'å…¥ç¡æ—¶é—´',
                'sleepEnd': 'é†’æ¥æ—¶é—´',
                'happy1': 'æœ€å¼€å¿ƒ1',
                'happy2': 'æœ€å¼€å¿ƒ2',
                'happy3': 'æœ€å¼€å¿ƒ3',
                'action': 'ä»Šæ—¥æŒæ§æ„Ÿ',
                'selflove': 'ä»Šæ—¥è‡ªçˆ±è¡ŒåŠ¨',
                'trigger': 'æƒ…ç»ªè§¦å‘ç‚¹',
                'rescue': 'è‡ªæ•‘è¡Œä¸º',
                'spendTotal': 'æ¶ˆè´¹æ€»é¢',
                'spendEmo': 'æƒ…ç»ªæ€§æ¶ˆè´¹',
                'spendValue': 'æŠ•èµ„æ€§æ¶ˆè´¹',
                'todo1': 'æ˜å¤©ä»»åŠ¡1',
                'todo2': 'æ˜å¤©ä»»åŠ¡2',
                'todo3': 'æ˜å¤©ä»»åŠ¡3'
            };
            return map[fieldName] || fieldName;
        };

        // ========== å­˜å‚¨è¯»å†™ï¼ˆå¸¦ç‰ˆæœ¬å’Œå¤‡ä»½ï¼‰==========
        const readStore = () => {
            try {
                const cached = localStorage.getItem(storageKey);
                if (!cached) {
                    const initial = { _meta: { version: 3, lastBackupReminder: formatDate(new Date()) } };
                    localStorage.setItem(storageKey, JSON.stringify(initial));
                    storageUsageEl.textContent = 'å½“å‰å·²ç”¨å­˜å‚¨çº¦ï¼š0.1 KB';
                    return initial;
                }
                let store = JSON.parse(cached);
                if (!store._meta) {
                    store = { _meta: { version: 1, lastBackupReminder: formatDate(new Date()) }, ...store };
                }
                // === ç‰ˆæœ¬è¿ç§»ï¼ˆé¢„ç•™ï¼‰===
                if (store._meta.version < 3) {
                    // æœªæ¥åœ¨æ­¤æ·»åŠ è¿ç§»é€»è¾‘
                    store._meta.version = 3;
                }
                // === å®šæœŸå¤‡ä»½æé†’ ===
                const recordCount = Object.keys(store).filter(k => k !== '_meta').length;
                if (recordCount >= 10) {
                    const lastReminder = new Date(store._meta.lastBackupReminder);
                    const now = new Date();
                    const diffDays = (now - lastReminder) / (1000 * 60 * 60 * 24);
                    if (diffDays > 30) {
                        showToast('ğŸ’¡ æ¸©é¦¨æé†’ï¼šå»ºè®®å¯¼å‡º CSV/JSON å¤‡ä»½æ‚¨çš„è®°å½•ï¼');
                        store._meta.lastBackupReminder = formatDate(now);
                        writeStore(store);
                    }
                }
                storageUsageEl.textContent = `å½“å‰å·²ç”¨å­˜å‚¨çº¦ï¼š${getStorageUsage(store)} KB`;
                return store;
            } catch (e) {
                showToast('âš ï¸ æœ¬åœ°æ•°æ®æŸåï¼Œå·²é‡ç½®ã€‚');
                const initial = { _meta: { version: 3, lastBackupReminder: formatDate(new Date()) } };
                localStorage.setItem(storageKey, JSON.stringify(initial));
                localStorage.setItem(storageKey + '-backup', JSON.stringify(initial));
                storageUsageEl.textContent = 'å½“å‰å·²ç”¨å­˜å‚¨çº¦ï¼š0.1 KB';
                return initial;
            }
        };

        const writeStore = (data) => {
            try {
                localStorage.setItem(storageKey, JSON.stringify(data));
                localStorage.setItem(storageKey + '-backup', JSON.stringify(data)); // è‡ªåŠ¨å¤‡ä»½
            } catch (e) {
                showToast('âŒ ä¿å­˜å¤±è´¥ï¼šå­˜å‚¨ç©ºé—´ä¸è¶³');
            }
        };

        // ========== è®°å½•æœ‰æ•ˆæ€§åˆ¤å®šï¼ˆèåˆ v3 æ»‘å—é€»è¾‘ + å­—æ®µé…ç½®ï¼‰==========
        const isRecordSignificant = (payload) => {
            // 1. ç¡çœ æ—¶é—´ä»»ä¸€æœ‰å€¼ â†’ æœ‰æ•ˆ
            if (payload.sleepStart || payload.sleepEnd) return true;
            // 2. å…¶ä»–éè¯„åˆ†å­—æ®µæœ‰å†…å®¹
            for (const key in payload) {
                if (['date', 'updatedAt', 'mood', 'energy'].includes(key)) continue;
                if (payload[key] && payload[key].toString().trim() !== '') return true;
            }
            // 3. è¯„åˆ†å­—æ®µï¼šå¿…é¡»è¢«ç”¨æˆ·ä¸»åŠ¨è§¦æ‘¸è¿‡ï¼ˆv3 æ ¸å¿ƒï¼‰
            if (moodTouched && payload.mood !== undefined) return true;
            if (energyTouched && payload.energy !== undefined) return true;
            return false;
        };
        // ç”¨äºæ—¥å†/å›¾è¡¨æ˜¾ç¤ºï¼šåªè¦æ•°æ®éç©ºï¼Œå°±è§†ä¸ºæœ‰æ•ˆï¼ˆä¸ä¾èµ–è§¦æ‘¸çŠ¶æ€ï¼‰
        const isRecordSignificantForDisplay = (payload) => {
            if (!payload) return false;
            // ç¡çœ æœ‰å€¼
            if (payload.sleepStart || payload.sleepEnd) return true;
            // å…¶ä»–å­—æ®µæœ‰å†…å®¹
            for (const key in payload) {
                if (['date', 'updatedAt'].includes(key)) continue;
                if (payload[key] && payload[key].toString().trim() !== '') return true;
            }
            // è¯„åˆ†ä¸æ˜¯é»˜è®¤5
            if (payload.mood && payload.mood !== '5') return true;
            if (payload.energy && payload.energy !== '5') return true;
            return false;
};

        // ========== å¿…å¡«é¡¹æé†’é€»è¾‘ï¼ˆä»…å½“å…¶ä»–å†…å®¹å·²å¡«æ—¶è§¦å‘ï¼‰==========
        const shouldRemindRequired = (payload) => {
            if (!isRecordSignificant(payload)) return false;
            // æ£€æŸ¥å¿…å¡«å­—æ®µæ˜¯å¦ä¸ºç©º
            for (const key in FIELDS_CONFIG) {
                if (FIELDS_CONFIG[key].required) {
                    const value = payload[key];
                    if (!value || value.toString().trim() === '') {
                        return true;
                    }
                }
            }
            return false;
        };

        // ========== UI ç›¸å…³ ==========
        const clearFields = () => {
            fields.forEach(el => {
                if (el.type === 'range') {
                    el.value = '5';
                    updateRangeValue(el.id);
                } else {
                    el.value = '';
                }
            });
            moodTouched = false;
            energyTouched = false;
        };

        const updateRangeValue = (id) => {
            const range = document.getElementById(id);
            const valueDisplay = document.getElementById(id.replace('-range', '-value'));
            if (range && valueDisplay) valueDisplay.textContent = range.value;
        };

        const setFieldsReadonly = (readonly) => {
            fields.forEach(el => readonly ? el.setAttribute('readonly', 'readonly') : el.removeAttribute('readonly'));
        };

        const checkFutureDateAndDisable = (targetDate) => {
            const isFuture = isFutureDate(targetDate);
            const isTodayDate = targetDate === formatDate(new Date());
            fields.forEach(el => el.disabled = isFuture);
            if (nextDayBtn) nextDayBtn.disabled = isTodayDate || isFuture;
            if (clearDayBtn) clearDayBtn.disabled = isFuture;
            if (toggleEditBtn) toggleEditBtn.disabled = isFuture || isTodayDate;
            if (isFuture) {
                dateStatus.innerHTML = `<span style="color: #ef4444; font-weight: bold;">æœªæ¥æ—¥æœŸï¼š${targetDate}ã€‚æ— æ³•å¡«å†™ã€‚</span>`;
                clearFields();
                if (lastSaveEl) lastSaveEl.textContent = '';
                setFieldsReadonly(false);
                return true;
            }
            if (!isTodayDate) {
                setFieldsReadonly(true);
                toggleEditBtn.textContent = 'ğŸ”“ ä¿®æ”¹å†å²è®°å½•';
                editMode = false;
            } else {
                setFieldsReadonly(false);
                toggleEditBtn.textContent = 'ğŸ”’ é”å®šç¼–è¾‘ï¼ˆé˜²è¯¯è§¦ï¼‰';
                editMode = true;
            }
            return false;
        };

        const updateStatus = (date, hasData, updatedAt) => {
            dateStatus.textContent = hasData ? `å·²åŠ è½½ï¼š${date}` : `å½“å‰æ—¥æœŸæš‚æ— è®°å½•ï¼š${date}`;
            if (lastSaveEl && updatedAt) {
                const d = new Date(updatedAt);
                lastSaveEl.textContent = `æœ€è¿‘ä¿å­˜ï¼š${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
            } else if (lastSaveEl) {
                lastSaveEl.textContent = '';
            }
        };

        // ========== æ•°æ®åŠ è½½ä¸ä¿å­˜ ==========
        const loadData = (targetDate = getCurrentDate()) => {
            dateInput.value = targetDate;
            if (checkFutureDateAndDisable(targetDate)) {
                generateSummaryChart(readStore());
                renderCalendar(currentMonth, readStore());
                return;
            }
            const store = readStore();
            clearFields();
            const data = store[targetDate] || {};
            fields.forEach(el => {
                if (data[el.name] !== undefined) {
                    el.value = data[el.name];
                    if (el.type === 'range') updateRangeValue(el.id);
                }
            });
            // æ¢å¤è§¦æ‘¸çŠ¶æ€ï¼ˆä»…å½“å€¼ â‰  5ï¼‰
            if (data.mood && data.mood !== '5') moodTouched = true;
            if (data.energy && data.energy !== '5') energyTouched = true;
            const hasData = !!store[targetDate] && isRecordSignificant(store[targetDate]);
            updateStatus(targetDate, hasData, data.updatedAt);
            generateSummaryChart(store);
            renderCalendar(currentMonth, store);
        };

        const saveData = (targetDate = getCurrentDate(), silent = false) => {
            if (!targetDate || isFutureDate(targetDate)) return;
            const store = readStore();
            const payload = {};
            fields.forEach(el => {
                if (!el.disabled && !el.readOnly) payload[el.name] = el.value;
            });
            if (isRecordSignificant(payload)) {
                payload.date = targetDate;
                payload.updatedAt = Date.now();
                store[targetDate] = payload;
                writeStore(store);
                updateStatus(targetDate, true, payload.updatedAt);
                // === æ–°å¢ï¼šå¿…å¡«é¡¹æé†’ ===
                if (shouldRemindRequired(payload)) {
                    showToast('ğŸ’¡ æé†’ï¼šç¡çœ æ—¶é—´æ˜¯å¿…å¡«é¡¹ï¼Œè¯·å°½é‡å¡«å†™');
                } else if (!silent) {
                    showToast('å·²è‡ªåŠ¨ä¿å­˜');
                }
            } else {
                if (store[targetDate]) {
                    delete store[targetDate];
                    writeStore(store);
                    updateStatus(targetDate, false, undefined);
                    if (!silent) showToast('å·²æ¸…ç©ºï¼ˆæ— æœ‰æ•ˆè®°å½•ï¼‰');
                }
            }
            generateSummaryChart(store);
            renderCalendar(currentMonth, store);
        };

        const getCurrentDate = () => dateInput?.value || '';

        // ========== æ—¥æœŸå¯¼èˆª ==========
        const handleDateChange = (newDate) => {
            if (!newDate) return;
            if (!fields[0].readOnly) saveData(lastDate || getCurrentDate(), true);
            lastDate = newDate;
            loadData(newDate);
        };

        const shiftDate = (delta) => {
            const base = dateInput.value ? new Date(dateInput.value.replace(/-/g, '/')) : new Date();
            base.setDate(base.getDate() + delta);
            handleDateChange(formatDate(base));
        };

        const goToday = () => handleDateChange(formatDate(new Date()));

        const clearCurrent = () => {
            const current = getCurrentDate();
            if (!current || isFutureDate(current)) return;
            if (!confirm(`ç¡®å®šè¦æ¸…ç©º ${current} çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ`)) return;
            const store = readStore();
            delete store[current];
            writeStore(store);
            clearFields();
            updateStatus(current, false, undefined);
            generateSummaryChart(store);
            renderCalendar(currentMonth, store);
            showToast('å·²æ¸…ç©ºå½“å‰æ—¥æœŸæ•°æ®');
        };

        const toggleEditMode = () => {
            const current = getCurrentDate();
            if (isFutureDate(current) || current === formatDate(new Date())) return;
            editMode = !editMode;
            setFieldsReadonly(!editMode);
            toggleEditBtn.textContent = editMode ? 'ğŸ”’ é”å®šç¼–è¾‘' : 'ğŸ”“ ä¿®æ”¹å†å²è®°å½•';
            if (editMode) showToast('å·²è§£é”ï¼Œå¯ç¼–è¾‘å†å²è®°å½•');
            else { showToast('å·²é”å®šï¼Œé˜²æ­¢è¯¯è§¦'); saveData(current, true); }
        };

        // ========== æ—¥å† ==========
        const todayDate = formatDate(new Date());
        const renderCalendar = (dateObj, store) => {
            const grid = document.getElementById('calendar-grid');
            const monthYearDisplay = document.getElementById('current-month-year');
            if (!grid || !monthYearDisplay) return;
            while (grid.children.length > 7) grid.removeChild(grid.lastChild);
            const year = dateObj.getFullYear();
            const month = dateObj.getMonth();
            const currentDate = getCurrentDate();
            monthYearDisplay.textContent = `${year} å¹´ ${month + 1} æœˆ`;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'calendar-day empty-day';
                grid.appendChild(empty);
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = formatDate(new Date(year, month, day));
                const cell = document.createElement('div');
                cell.className = 'calendar-day';
                cell.textContent = day;
                cell.setAttribute('data-date', dateStr);
                if (dateStr === todayDate) cell.classList.add('today');
                if (dateStr === currentDate) cell.classList.add('selected-day');
                const rec = store[dateStr];
                if (rec && isRecordSignificantForDisplay(rec)) {
                    if (!cell.classList.contains('selected-day')) cell.classList.add('recorded');
                    const mark = document.createElement('span');
                    mark.className = 'recorded-mark';
                    mark.textContent = 'âœ…';
                    cell.appendChild(mark);
                }
                cell.addEventListener('click', (ev) => {
                    const td = ev.currentTarget.getAttribute('data-date');
                    if (td && !ev.currentTarget.classList.contains('empty-day')) {
                        handleDateChange(td);
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                });
                grid.appendChild(cell);
            }
        };

        const shiftCalendarMonth = (delta) => {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar(currentMonth, readStore());
        };

        // ========== å›¾è¡¨ ==========
        const generateSummaryChart = (store) => {
            const chartContainer = document.getElementById('chart-container');
            if (!chartContainer) return;
            const allDates = Object.keys(store).filter(k => k !== '_meta').sort((a,b)=>new Date(a)-new Date(b));
            const last7Days = allDates.slice(-7);
            chartContainer.innerHTML = '';
            if (last7Days.length === 0) {
                chartContainer.innerHTML = '<div style="text-align:center;color:#6b7280;padding:30px 0;width:100%;">æš‚æ— æœ€è¿‘çš„è®°å½•æ•°æ®ã€‚</div>';
                return;
            }
            const maxBarHeight = 100;
            [{score:10,label:'10'},{score:5,label:'5'}].forEach(ref => {
                const line = document.createElement('div');
                line.className = 'chart-ref-line';
                line.style.bottom = `${(ref.score/10)*maxBarHeight}px`;
                chartContainer.appendChild(line);
                const label = document.createElement('span');
                label.className = 'ref-label';
                label.textContent = ref.label;
                label.style.bottom = `${(ref.score/10)*maxBarHeight}px`;
                chartContainer.appendChild(label);
            });
            last7Days.forEach(dateStr => {
                const data = store[dateStr];
                if (!data || !isRecordSignificantForDisplay(data)) return;
                const moodScore = Math.min(10, Math.max(0, parseInt(data.mood||0)));
                const energyScore = Math.min(10, Math.max(0, parseInt(data.energy||0)));
                const dayChart = document.createElement('div');
                dayChart.className = 'day-chart';
                const barGroup = document.createElement('div');
                barGroup.className = 'bar-group';
                const moodBar = document.createElement('div');
                moodBar.className = 'chart-bar chart-bar-mood';
                moodBar.style.height = `${moodScore*10}px`;
                const energyBar = document.createElement('div');
                energyBar.className = 'chart-bar chart-bar-energy';
                energyBar.style.height = `${energyScore*10}px`;
                if (moodScore > 0) {
                    const lbl = document.createElement('div');
                    lbl.className = 'score-label mood-label';
                    lbl.textContent = moodScore;
                    lbl.style.bottom = `${moodScore*10}px`;
                    barGroup.appendChild(lbl);
                }
                if (energyScore > 0) {
                    const lbl = document.createElement('div');
                    lbl.className = 'score-label energy-label';
                    lbl.textContent = energyScore;
                    lbl.style.bottom = `${energyScore*10}px`;
                    barGroup.appendChild(lbl);
                }
                barGroup.appendChild(moodBar);
                barGroup.appendChild(energyBar);
                const label = document.createElement('div');
                label.className = 'chart-label';
                label.textContent = dateStr.substring(5);
                dayChart.appendChild(barGroup);
                dayChart.appendChild(label);
                chartContainer.appendChild(dayChart);
            });
        };

        // ========== å¯¼å‡º ==========
        const downloadFile = (filename, content, type = 'text/plain;charset=utf-8') => {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        };

        const getRecordedDates = () => {
            const store = readStore();
            return Object.keys(store).filter(k => k !== '_meta').sort();
        };

        const exportAllToMarkdown = () => {
            const sortedDates = getRecordedDates();
            let content = `# å…¨éƒ¨æƒ…ç»ªä¸æŒæ§æ„Ÿè®°å½•ï¼ˆå…± ${sortedDates.length} å¤©ï¼‰\n`;
            sortedDates.forEach(date => {
                const d = readStore()[date];
                if (!isRecordSignificant(d)) return;
                content += `## ${date}\n- æƒ…ç»ªè¯„åˆ†: ${d.mood || '5'}\n- èƒ½é‡è¯„åˆ†: ${d.energy || '5'}\n- ç¡çœ : ${d.sleepStart || ''} - ${d.sleepEnd || ''}\n`;
                content += `### ä»Šæ—¥æœ€å¼€å¿ƒçš„ä¸‰ä»¶äº‹\n1. ${d.happy1 || ''}\n2. ${d.happy2 || ''}\n3. ${d.happy3 || ''}\n`;
                content += `### ä»Šæ—¥çš„æŒæ§æ„Ÿ\n${d.action || ''}\n### ä»Šæ—¥çš„è‡ªçˆ±è¡ŒåŠ¨\n${d.selflove || ''}\n`;
                content += `### æƒ…ç»ªè§¦å‘ç‚¹\n${d.trigger || ''}\n### è‡ªæ•‘è¡Œä¸º\n${d.rescue || ''}\n`;
                content += `### æ¶ˆè´¹é€Ÿè§ˆ\n- æ€»é¢: ${d.spendTotal || ''}\n- æƒ…ç»ªæ€§æ¶ˆè´¹: ${d.spendEmo || ''}\n- æŠ•èµ„æ€§æ¶ˆè´¹: ${d.spendValue || ''}\n`;
                content += `### æ˜å¤©ä¸‰ä»¶å°äº‹\n1. ${d.todo1 || ''}\n2. ${d.todo2 || ''}\n3. ${d.todo3 || ''}\n---\n`;
            });
            const filename = sortedDates.length ? `MoodLog_${sortedDates[0]}_to_${sortedDates[sortedDates.length-1]}.md` : 'MoodLog_empty.md';
            downloadFile(filename, content);
        };

        const exportAllToCSV = () => {
            const sortedDates = getRecordedDates();
            const headers = ['æ—¥æœŸ','æƒ…ç»ªè¯„åˆ†','èƒ½é‡è¯„åˆ†','å…¥ç¡æ—¶é—´','é†’æ¥æ—¶é—´','æœ€å¼€å¿ƒ1','æœ€å¼€å¿ƒ2','æœ€å¼€å¿ƒ3','ä»Šæ—¥æŒæ§æ„Ÿ','ä»Šæ—¥è‡ªçˆ±è¡ŒåŠ¨','æƒ…ç»ªè§¦å‘ç‚¹','è‡ªæ•‘è¡Œä¸º','æ¶ˆè´¹æ€»é¢','æƒ…ç»ªæ€§æ¶ˆè´¹','æŠ•èµ„æ€§æ¶ˆè´¹','æ˜å¤©ä»»åŠ¡1','æ˜å¤©ä»»åŠ¡2','æ˜å¤©ä»»åŠ¡3','æœ€åä¿å­˜æ—¶é—´'];
            let csv = headers.join(',') + '\n';
            sortedDates.forEach(date => {
                const d = readStore()[date];
                if (!isRecordSignificant(d)) return;
                const row = [
                    date, d.mood||'5', d.energy||'5',
                    `"${(d.sleepStart||'').replace(/"/g,'""')}"`, `"${(d.sleepEnd||'').replace(/"/g,'""')}"`,
                    `"${(d.happy1||'').replace(/"/g,'""')}"`, `"${(d.happy2||'').replace(/"/g,'""')}"`, `"${(d.happy3||'').replace(/"/g,'""')}"`,
                    `"${(d.action||'').replace(/"/g,'""')}"`, `"${(d.selflove||'').replace(/"/g,'""')}"`,
                    `"${(d.trigger||'').replace(/"/g,'""')}"`, `"${(d.rescue||'').replace(/"/g,'""')}"`,
                    d.spendTotal||'', `"${(d.spendEmo||'').replace(/"/g,'""')}"`, `"${(d.spendValue||'').replace(/"/g,'""')}"`,
                    `"${(d.todo1||'').replace(/"/g,'""')}"`, `"${(d.todo2||'').replace(/"/g,'""')}"`, `"${(d.todo3||'').replace(/"/g,'""')}"`,
                    d.updatedAt ? new Date(d.updatedAt).toLocaleString('zh-CN') : ''
                ];
                csv += row.join(',') + '\n';
            });
            const BOM = '\uFEFF';
            const filename = sortedDates.length ? `MoodLog_${sortedDates[0]}_to_${sortedDates[sortedDates.length-1]}.csv` : 'MoodLog_empty.csv';
            downloadFile(filename, BOM + csv, 'text/csv;charset=utf-8');
        };

        const exportAllToJSON = () => {
            const store = readStore();
            const cleanStore = {};
            const sortedDates = getRecordedDates();
            sortedDates.forEach(date => {
                const d = store[date];
                if (isRecordSignificant(d)) cleanStore[date] = d;
            });
            const filename = sortedDates.length ? `MoodLog_${sortedDates[0]}_to_${sortedDates[sortedDates.length-1]}.json` : 'MoodLog_empty.json';
            downloadFile(filename, JSON.stringify(cleanStore, null, 2));
        };

        const exportSingleMarkdown = () => {
            const current = getCurrentDate();
            const store = readStore();
            const d = store[current] || {};
            if (!isRecordSignificant(d)) {
                showToast('å½“å¤©æ— æœ‰æ•ˆè®°å½•');
                return;
            }
            let content = `# ${current} æƒ…ç»ªä¸æŒæ§æ„Ÿè®°å½•\n- æƒ…ç»ªè¯„åˆ†: ${d.mood || '5'}\n- èƒ½é‡è¯„åˆ†: ${d.energy || '5'}\n- ç¡çœ : ${d.sleepStart || ''} - ${d.sleepEnd || ''}\n`;
            content += `### ä»Šæ—¥æœ€å¼€å¿ƒçš„ä¸‰ä»¶äº‹\n1. ${d.happy1 || ''}\n2. ${d.happy2 || ''}\n3. ${d.happy3 || ''}\n`;
            content += `### ä»Šæ—¥çš„æŒæ§æ„Ÿ\n${d.action || ''}\n### ä»Šæ—¥çš„è‡ªçˆ±è¡ŒåŠ¨\n${d.selflove || ''}\n`;
            content += `### æƒ…ç»ªè§¦å‘ç‚¹\n${d.trigger || ''}\n### è‡ªæ•‘è¡Œä¸º\n${d.rescue || ''}\n`;
            content += `### æ¶ˆè´¹é€Ÿè§ˆ\n- æ€»é¢: ${d.spendTotal || ''}\n- æƒ…ç»ªæ€§æ¶ˆè´¹: ${d.spendEmo || ''}\n- æŠ•èµ„æ€§æ¶ˆè´¹: ${d.spendValue || ''}\n`;
            content += `### æ˜å¤©ä¸‰ä»¶å°äº‹\n1. ${d.todo1 || ''}\n2. ${d.todo2 || ''}\n3. ${d.todo3 || ''}\n`;
            downloadFile(`MoodLog_${current}.md`, content);
        };

        const exportSingleCSV = () => {
            const current = getCurrentDate();
            const store = readStore();
            const d = store[current] || {};
            if (!isRecordSignificant(d)) {
                showToast('å½“å¤©æ— æœ‰æ•ˆè®°å½•');
                return;
            }
            const headers = ['æ—¥æœŸ','æƒ…ç»ªè¯„åˆ†','èƒ½é‡è¯„åˆ†','å…¥ç¡æ—¶é—´','é†’æ¥æ—¶é—´','æœ€å¼€å¿ƒ1','æœ€å¼€å¿ƒ2','æœ€å¼€å¿ƒ3','ä»Šæ—¥æŒæ§æ„Ÿ','ä»Šæ—¥è‡ªçˆ±è¡ŒåŠ¨','æƒ…ç»ªè§¦å‘ç‚¹','è‡ªæ•‘è¡Œä¸º','æ¶ˆè´¹æ€»é¢','æƒ…ç»ªæ€§æ¶ˆè´¹','æŠ•èµ„æ€§æ¶ˆè´¹','æ˜å¤©ä»»åŠ¡1','æ˜å¤©ä»»åŠ¡2','æ˜å¤©ä»»åŠ¡3','æœ€åä¿å­˜æ—¶é—´'];
            const row = [
                current, d.mood||'5', d.energy||'5',
                `"${(d.sleepStart||'').replace(/"/g,'""')}"`, `"${(d.sleepEnd||'').replace(/"/g,'""')}"`,
                `"${(d.happy1||'').replace(/"/g,'""')}"`, `"${(d.happy2||'').replace(/"/g,'""')}"`, `"${(d.happy3||'').replace(/"/g,'""')}"`,
                `"${(d.action||'').replace(/"/g,'""')}"`, `"${(d.selflove||'').replace(/"/g,'""')}"`,
                `"${(d.trigger||'').replace(/"/g,'""')}"`, `"${(d.rescue||'').replace(/"/g,'""')}"`,
                d.spendTotal||'', `"${(d.spendEmo||'').replace(/"/g,'""')}"`, `"${(d.spendValue||'').replace(/"/g,'""')}"`,
                `"${(d.todo1||'').replace(/"/g,'""')}"`, `"${(d.todo2||'').replace(/"/g,'""')}"`, `"${(d.todo3||'').replace(/"/g,'""')}"`,
                d.updatedAt ? new Date(d.updatedAt).toLocaleString('zh-CN') : ''
            ];
            const csv = headers.join(',') + '\n' + row.join(',') + '\n';
            const BOM = '\uFEFF';
            downloadFile(`MoodLog_${current}.csv`, BOM + csv, 'text/csv;charset=utf-8');
        };

        const exportSingleJSON = () => {
            const current = getCurrentDate();
            const store = readStore();
            const d = store[current] || {};
            if (!isRecordSignificant(d)) {
                showToast('å½“å¤©æ— æœ‰æ•ˆè®°å½•');
                return;
            }
            downloadFile(`MoodLog_${current}.json`, JSON.stringify({[current]: d}, null, 2));
        };

        // ========== å¯¼å…¥ ==========
        document.getElementById('import-file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const text = ev.target.result;
                let newData = {};
                if (file.name.endsWith('.json')) {
                    try {
                        newData = JSON.parse(text);
                        if (newData._meta) delete newData._meta;
                    } catch {
                        showToast('JSON æ ¼å¼é”™è¯¯');
                        return;
                    }
                } else {
                    const lines = text.split(/\r?\n/);
                    if (lines.length < 2) { showToast('CSV æ ¼å¼é”™è¯¯'); return; }
                    const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                    const dateIndex = headers.indexOf('æ—¥æœŸ');
                    if (dateIndex === -1) { showToast('CSV ç¼ºå°‘â€œæ—¥æœŸâ€åˆ—'); return; }
                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        const values = lines[i].split(',').map(v => {
                            v = v.trim();
                            if (v.startsWith('"') && v.endsWith('"')) v = v.slice(1, -1).replace(/""/g, '"');
                            return v;
                        });
                        const date = values[dateIndex];
                        if (!date || isFutureDate(date)) continue;
                        const record = {};
                        for (const key in FIELDS_CONFIG) {
                            const label = getFieldLabel(key);
                            const idx = headers.indexOf(label);
                            record[key] = (idx >= 0 && values[idx]) ? values[idx] : FIELDS_CONFIG[key].default || '';
                        }
                        record.updatedAt = Date.now();
                        if (isRecordSignificant(record)) {
                            newData[date] = record;
                        }
                    }
                }
                if (Object.keys(newData).length === 0) {
                    showToast('æœªå‘ç°æœ‰æ•ˆè®°å½•');
                    return;
                }
                const store = readStore();
                const conflictDates = Object.keys(newData).filter(date => store[date]);
                if (conflictDates.length > 0) {
                    const msg = `å‘ç° ${conflictDates.length} å¤©å·²æœ‰è®°å½•ï¼Œé€‰æ‹©æ“ä½œï¼š\n1-è¦†ç›– 2-è·³è¿‡ 3-åˆå¹¶`;
                    const choice = prompt(msg);
                    if (choice === '1') Object.assign(store, newData);
                    else if (choice === '2') {
                        conflictDates.forEach(d => delete newData[d]);
                        Object.assign(store, newData);
                    } else if (choice === '3') {
                        conflictDates.forEach(d => store[d] = { ...store[d], ...newData[d] });
                        Object.keys(newData).forEach(d => { if (!store[d]) store[d] = newData[d]; });
                    } else return;
                } else {
                    Object.assign(store, newData);
                }
                writeStore(store);
                generateSummaryChart(store);
                renderCalendar(currentMonth, store);
                loadData(getCurrentDate());
                showToast(`æˆåŠŸå¯¼å…¥ ${Object.keys(newData).length} å¤©è®°å½•`);
            };
            reader.readAsText(file, 'UTF-8');
        });

        // ========== åˆå§‹åŒ– ==========
        const init = () => {
            // ç»‘å®šæ»‘å—è§¦æ‘¸äº‹ä»¶ï¼ˆå…³é”®ï¼ï¼‰
            document.getElementById('mood-range').addEventListener('input', () => moodTouched = true);
            document.getElementById('energy-range').addEventListener('input', () => energyTouched = true);

            const today = formatDate(new Date());
            if (!dateInput.value) dateInput.value = today;
            updateRangeValue('mood-range');
            updateRangeValue('energy-range');
            lastDate = getCurrentDate();
            loadData(lastDate);

            fields.forEach(el => el.addEventListener('input', (e) => {
                if (e.target.type === 'range') updateRangeValue(e.target.id);
                if (isFutureDate(getCurrentDate())) return;
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => saveData(getCurrentDate(), false), 1200);
            }));
            // å®æ—¶æ›´æ–°å­—æ•°/è¡Œæ•°æç¤º
            document.querySelectorAll('textarea').forEach(ta => {
                const countEl = document.querySelector(`.char-count[data-target="${ta.name}"]`);
                if (!countEl) return;
                const updateCount = () => {
                    if (ta.hasAttribute('maxlength')) {
                        const len = ta.value.length;
                        const max = parseInt(ta.getAttribute('maxlength'));
                        countEl.textContent = `${len} / ${max}`;
                        countEl.style.color = len > max * 0.9 ? '#dc2626' : '#6b7280';
                    } else {
                        const lines = ta.value.split('\n').filter(l => l.trim() !== '').length;
                        countEl.textContent = `${lines} è¡Œ`;
                    }
                };
                ta.addEventListener('input', updateCount);
                updateCount(); // åˆå§‹åŒ–
            });
            dateInput.addEventListener('change', (e) => handleDateChange(e.target.value));
            document.getElementById('prev-day').addEventListener('click', () => shiftDate(-1));
            document.getElementById('next-day').addEventListener('click', () => shiftDate(1));
            document.getElementById('goto-today').addEventListener('click', goToday);
            document.getElementById('toggle-edit').addEventListener('click', toggleEditMode);
            document.getElementById('clear-day').addEventListener('click', clearCurrent);
            document.getElementById('export-all-md').addEventListener('click', exportAllToMarkdown);
            document.getElementById('export-all-csv').addEventListener('click', exportAllToCSV);
            document.getElementById('export-all-json').addEventListener('click', exportAllToJSON);
            document.getElementById('export-single-md').addEventListener('click', exportSingleMarkdown);
            document.getElementById('export-single-csv').addEventListener('click', exportSingleCSV);
            document.getElementById('export-single-json').addEventListener('click', exportSingleJSON);
            document.getElementById('print-page').addEventListener('click', () => window.print());
            document.getElementById('prev-month-btn').addEventListener('click', () => shiftCalendarMonth(-1));
            document.getElementById('next-month-btn').addEventListener('click', () => shiftCalendarMonth(1));
        };

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>